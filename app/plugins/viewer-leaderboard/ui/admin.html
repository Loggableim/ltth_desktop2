<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéÆ Viewer XP & Leaderboard - Admin Panel</title>
  <link rel="stylesheet" href="/css/themes.css">
  <link href="/css/vendor/bootstrap.min.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--color-bg-primary);
      color: var(--color-text-primary);
      min-height: 100vh;
    }

    /* Modern App Layout */
    .app-container {
      display: flex;
      height: 100vh;
    }

    /* Sidebar Navigation */
    .sidebar {
      width: 280px;
      background: var(--color-bg-secondary);
      border-right: 1px solid var(--color-border);
      padding: 24px 20px;
      overflow-y: auto;
      flex-shrink: 0;
    }

    .sidebar-logo {
      font-size: 1.5rem;
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-subtitle {
      color: var(--color-text-muted);
      font-size: 0.875rem;
      margin-bottom: 32px;
    }

    .nav-section {
      margin-bottom: 24px;
    }

    .nav-section-title {
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted);
      margin-bottom: 12px;
      padding: 0 12px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--color-text-secondary);
      text-decoration: none;
      margin-bottom: 4px;
      border: 1px solid transparent;
    }

    .nav-item:hover {
      background: var(--color-bg-hover);
      color: var(--color-text-primary);
    }

    .nav-item.active {
      background: var(--color-active-bg);
      border-color: var(--color-active-border);
      color: var(--color-accent-primary);
      font-weight: 600;
    }

    .nav-icon {
      font-size: 1.25rem;
      width: 24px;
      text-align: center;
    }

    /* Main Content Area */
    .main-content {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
    }

    .page-header {
      margin-bottom: 32px;
    }

    .page-title {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .page-description {
      color: var(--color-text-secondary);
      font-size: 1rem;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      padding: 24px;
      transition: all 0.2s;
    }

    .stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .stat-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .stat-card-icon {
      font-size: 2rem;
      opacity: 0.8;
    }

    .stat-card-value {
      font-size: 2rem;
      font-weight: 700;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .stat-card-label {
      font-size: 0.875rem;
      color: var(--color-text-muted);
      margin-top: 4px;
    }

    .stat-card-change {
      font-size: 0.75rem;
      margin-top: 8px;
      padding: 4px 8px;
      border-radius: 4px;
      display: inline-block;
    }

    .stat-card-change.positive {
      background: rgba(16, 185, 129, 0.1);
      color: var(--color-accent-success);
    }

    /* Card Component */
    .card {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      margin-bottom: 24px;
      overflow: hidden;
    }

    .card-header {
      background: var(--color-bg-secondary);
      border-bottom: 1px solid var(--color-border);
      padding: 16px 24px;
      font-weight: 600;
      font-size: 1.125rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .card-header-icon {
      margin-right: 8px;
    }

    .card-body {
      padding: 24px;
    }

    /* Modern Table */
    .modern-table {
      width: 100%;
      border-collapse: collapse;
    }

    .modern-table thead th {
      background: var(--color-bg-secondary);
      color: var(--color-text-secondary);
      font-weight: 600;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 12px 16px;
      text-align: left;
      border-bottom: 2px solid var(--color-border);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .modern-table tbody td {
      padding: 16px;
      border-bottom: 1px solid var(--color-border);
      color: var(--color-text-primary);
    }

    .modern-table tbody tr {
      transition: all 0.2s;
    }

    .modern-table tbody tr:hover {
      background: var(--color-bg-hover);
    }

    /* Badge */
    .badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-block;
    }

    .badge-primary {
      background: var(--color-active-bg);
      color: var(--color-accent-primary);
    }

    .badge-success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--color-accent-success);
    }

    .badge-warning {
      background: rgba(245, 158, 11, 0.1);
      color: var(--color-accent-warning);
    }

    .badge-danger {
      background: rgba(239, 68, 68, 0.1);
      color: var(--color-accent-danger);
    }

    .badge-level {
      background: var(--gradient-primary);
      color: white;
      font-weight: 700;
    }

    /* Modern Forms */
    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: var(--color-text-secondary);
      font-size: 0.875rem;
    }

    .form-control, .form-select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--color-input-border);
      background: var(--color-input-bg);
      color: var(--color-input-text);
      font-family: inherit;
      transition: all 0.2s;
    }

    .form-control:focus, .form-select:focus {
      outline: none;
      border-color: var(--color-accent-primary);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .form-control::placeholder {
      color: var(--color-input-placeholder);
    }

    .form-text {
      font-size: 0.875rem;
      color: var(--color-text-muted);
      margin-top: 4px;
      display: block;
    }

    .form-check {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .form-check-input {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .form-check-label {
      cursor: pointer;
      color: var(--color-text-primary);
    }

    /* Modern Buttons */
    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9375rem;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-primary {
      background: var(--color-accent-primary);
      color: white;
    }

    .btn-primary:hover {
      filter: brightness(1.1);
    }

    .btn-success {
      background: var(--color-accent-success);
      color: white;
    }

    .btn-success:hover {
      filter: brightness(1.1);
    }

    .btn-warning {
      background: var(--color-accent-warning);
      color: white;
    }

    .btn-danger {
      background: var(--color-accent-danger);
      color: white;
    }

    .btn-secondary {
      background: var(--color-btn-secondary-bg);
      color: var(--color-btn-secondary-text);
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.875rem;
    }

    /* XP Progress Bar */
    .xp-progress {
      height: 12px;
      background: var(--color-bg-tertiary);
      border-radius: 6px;
      overflow: hidden;
      margin: 8px 0;
    }

    .xp-progress-fill {
      height: 100%;
      background: var(--gradient-primary);
      transition: width 0.3s;
      position: relative;
      overflow: hidden;
    }

    .xp-progress-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background-image: linear-gradient(
        -45deg,
        rgba(255, 255, 255, .2) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255, 255, 255, .2) 50%,
        rgba(255, 255, 255, .2) 75%,
        transparent 75%,
        transparent
      );
      background-size: 20px 20px;
      animation: progress-animation 1s linear infinite;
    }

    @keyframes progress-animation {
      0% { background-position: 0 0; }
      100% { background-position: 20px 20px; }
    }

    /* OBS Panel Specific Styles */
    .obs-panel {
      background: var(--color-bg-secondary);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid var(--color-border);
    }

    .overlay-card {
      background: var(--color-bg-card);
      border: 1px solid var(--color-border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .overlay-card-title {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .overlay-url-box {
      background: var(--color-bg-tertiary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      padding: 12px;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
      color: var(--color-accent-success);
      word-break: break-all;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .url-text {
      flex: 1;
      user-select: all;
    }

    .copy-btn {
      flex-shrink: 0;
      padding: 6px 12px;
      font-size: 0.875rem;
      white-space: nowrap;
    }

    .overlay-preview {
      background: #000;
      border: 2px dashed var(--color-border);
      border-radius: 8px;
      padding: 16px;
      min-height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-text-muted);
      margin-top: 16px;
    }

    .overlay-settings {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 16px;
    }

    /* Alert Messages */
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }

    .alert-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid var(--color-accent-success);
      color: var(--color-accent-success);
    }

    .alert-warning {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid var(--color-accent-warning);
      color: var(--color-accent-warning);
    }

    .alert-danger {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid var(--color-accent-danger);
      color: var(--color-accent-danger);
    }

    .alert-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid var(--color-accent-primary);
      color: var(--color-accent-primary);
    }

    /* Search Box */
    .search-box {
      position: relative;
      margin-bottom: 20px;
    }

    .search-box input {
      padding-left: 40px;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--color-text-muted);
      pointer-events: none;
    }

    /* Modal */
    .modal-content {
      background: var(--color-modal-bg);
      border: 1px solid var(--color-border);
      border-radius: 16px;
    }

    .modal-header {
      border-bottom: 1px solid var(--color-border);
      padding: 20px 24px;
    }

    .modal-title {
      font-weight: 700;
      font-size: 1.25rem;
    }

    .modal-body {
      padding: 24px;
    }

    .modal-footer {
      border-top: 1px solid var(--color-border);
      padding: 16px 24px;
    }

    .btn-close-white {
      filter: invert(1);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--color-text-muted);
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 1.125rem;
      margin-bottom: 8px;
    }

    .empty-state-description {
      font-size: 0.875rem;
      color: var(--color-text-muted);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        border-right: none;
        border-bottom: 1px solid var(--color-border);
      }

      .main-content {
        padding: 16px;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--color-border);
      border-top-color: var(--color-accent-primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--color-bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--color-text-muted);
    }

    /* Tab Pane */
    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Rank Indicators */
    .rank-indicator {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-weight: 700;
      font-size: 0.875rem;
    }

    .rank-1 {
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      color: #000;
    }

    .rank-2 {
      background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%);
      color: #000;
    }

    .rank-3 {
      background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
      color: #fff;
    }

    .rank-default {
      background: var(--color-bg-tertiary);
      color: var(--color-text-secondary);
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar Navigation -->
    <div class="sidebar">
      <div class="sidebar-logo">
        üéÆ XP System
      </div>
      <div class="sidebar-subtitle">Viewer Gamification & Leaderboards</div>

      <nav>
        <div class="nav-section">
          <div class="nav-section-title">‚≠ê v2.1.0 Features</div>
          <a href="#" class="nav-item active" data-page="overview">
            <span class="nav-icon">üìä</span>
            <span>Overview</span>
          </a>
          <a href="#" class="nav-item" data-page="user-detail">
            <span class="nav-icon">üë§</span>
            <span>User Detail</span>
          </a>
          <a href="#" class="nav-item" data-page="config">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span>Configuration</span>
          </a>
          <a href="#" class="nav-item" data-page="logs">
            <span class="nav-icon">üìù</span>
            <span>Event Logs</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Classic Views</div>
          <a href="#" class="nav-item" data-page="dashboard">
            <span class="nav-icon">üìà</span>
            <span>Dashboard</span>
          </a>
          <a href="#" class="nav-item" data-page="leaderboard">
            <span class="nav-icon">üèÜ</span>
            <span>Leaderboard</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">OBS Overlays</div>
          <a href="#" class="nav-item" data-page="obs-panel">
            <span class="nav-icon">üé¨</span>
            <span>OBS Panel</span>
          </a>
          <a href="#" class="nav-item" data-page="overlay-preview">
            <span class="nav-icon">üëÅÔ∏è</span>
            <span>Live Preview</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">XP Management</div>
          <a href="#" class="nav-item" data-page="xp-settings">
            <span class="nav-icon">‚öôÔ∏è</span>
            <span>XP Settings</span>
          </a>
          <a href="#" class="nav-item" data-page="level-config">
            <span class="nav-icon">üìà</span>
            <span>Level Config</span>
          </a>
          <a href="#" class="nav-item" data-page="manual-award">
            <span class="nav-icon">üéÅ</span>
            <span>Manual Award</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Tools</div>
          <a href="#" class="nav-item" data-page="spin-settings">
            <span class="nav-icon">üé∞</span>
            <span>Spin Wheel</span>
          </a>
          <a href="#" class="nav-item" data-page="import-export">
            <span class="nav-icon">üíæ</span>
            <span>Import/Export</span>
          </a>
        </div>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- NEW: Overview Page (v2.1.0) -->
      <div id="page-overview" class="tab-content active">
        <div class="page-header">
          <h1 class="page-title">üìä Overview</h1>
          <p class="page-description">System overview with real-time statistics and leaderboard</p>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-icon">üë•</span>
            </div>
            <div class="stat-card-value" id="overview-total-viewers">-</div>
            <div class="stat-card-label">Total Viewers</div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-icon">‚≠ê</span>
            </div>
            <div class="stat-card-value" id="overview-total-xp">-</div>
            <div class="stat-card-label">Total XP Awarded</div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-icon">üìù</span>
            </div>
            <div class="stat-card-value" id="overview-total-events">-</div>
            <div class="stat-card-label">XP Events Today</div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-icon">üî•</span>
            </div>
            <div class="stat-card-value" id="overview-avg-level">-</div>
            <div class="stat-card-label">Average Level</div>
          </div>
        </div>

        <!-- Search Bar -->
        <div class="card">
          <div class="card-header">
            <span><span class="card-header-icon">üîç</span>Search Users</span>
          </div>
          <div class="card-body">
            <div class="form-group">
              <input type="text" id="overview-search-input" class="form-control" placeholder="Enter username to search...">
            </div>
            <div id="overview-search-results"></div>
          </div>
        </div>

        <!-- Top Leaderboard -->
        <div class="card">
          <div class="card-header">
            <span><span class="card-header-icon">üèÜ</span>Top Viewers</span>
            <select id="overview-period-filter" class="form-select" style="width: auto; padding: 6px 12px;">
              <option value="">All Time</option>
              <option value="7">Last 7 Days</option>
              <option value="30">Last 30 Days</option>
            </select>
          </div>
          <div class="card-body">
            <table class="modern-table">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>User</th>
                  <th>Level</th>
                  <th>XP</th>
                  <th>Streak</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="overview-leaderboard-body">
                <tr>
                  <td colspan="6" style="text-align: center; padding: 40px;">Loading...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- NEW: User Detail Page (v2.1.0) -->
      <div id="page-user-detail" class="tab-content">
        <div class="page-header">
          <h1 class="page-title">üë§ User Detail</h1>
          <p class="page-description">View and manage individual user information</p>
        </div>

        <!-- User Search -->
        <div class="card">
          <div class="card-header">
            <span><span class="card-header-icon">üîç</span>Find User</span>
          </div>
          <div class="card-body">
            <div class="form-group">
              <input type="text" id="user-detail-search" class="form-control" placeholder="Enter username...">
            </div>
            <button id="user-detail-search-btn" class="btn btn-primary">Search</button>
          </div>
        </div>

        <!-- User Info (hidden until search) -->
        <div id="user-detail-content" style="display: none;">
          <!-- User Profile Card -->
          <div class="card">
            <div class="card-header">
              <span><span class="card-header-icon">üë§</span><span id="user-detail-username">User</span></span>
              <button id="user-detail-opt-out-toggle" class="btn btn-sm btn-warning">Toggle Opt-Out</button>
            </div>
            <div class="card-body">
              <div class="stats-grid">
                <div class="stat-card">
                  <div class="stat-card-label">Current Level</div>
                  <div class="stat-card-value" id="user-detail-level">-</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-label">Total XP</div>
                  <div class="stat-card-value" id="user-detail-xp">-</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-label">XP to Next Level</div>
                  <div class="stat-card-value" id="user-detail-xp-to-next">-</div>
                </div>
                <div class="stat-card">
                  <div class="stat-card-label">Streak Days</div>
                  <div class="stat-card-value" id="user-detail-streak">-</div>
                </div>
              </div>

              <!-- Progress Bar -->
              <div class="form-group">
                <label class="form-label">Level Progress</label>
                <div style="background: var(--color-border); border-radius: 8px; height: 24px; position: relative; overflow: hidden;">
                  <div id="user-detail-progress-bar" style="background: var(--gradient-primary); height: 100%; width: 0%; transition: width 0.3s;"></div>
                  <div id="user-detail-progress-text" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; color: white; font-size: 0.75rem;">0%</div>
                </div>
              </div>

              <!-- Opt-Out Status -->
              <div id="user-detail-opt-out-status" class="badge badge-danger" style="display: none; margin-top: 12px;">
                ‚ùå User has opted out of XP tracking
              </div>
            </div>
          </div>

          <!-- Badges -->
          <div class="card">
            <div class="card-header">
              <span><span class="card-header-icon">üèÜ</span>Badges</span>
            </div>
            <div class="card-body" id="user-detail-badges">
              <p style="color: var(--color-text-muted);">No badges yet</p>
            </div>
          </div>

          <!-- Recent Events -->
          <div class="card">
            <div class="card-header">
              <span><span class="card-header-icon">üìù</span>Recent XP Events</span>
            </div>
            <div class="card-body">
              <table class="modern-table">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Event Type</th>
                    <th>XP Awarded</th>
                    <th>Details</th>
                  </tr>
                </thead>
                <tbody id="user-detail-events-body">
                  <tr>
                    <td colspan="4" style="text-align: center; padding: 20px;">No recent events</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- NEW: Configuration Page (v2.1.0) -->
      <div id="page-config" class="tab-content">
        <div class="page-header">
          <h1 class="page-title">‚öôÔ∏è Advanced Configuration</h1>
          <p class="page-description">Configure XP multipliers, rate limits, and system settings</p>
        </div>

        <!-- XP Multipliers -->
        <div class="card">
          <div class="card-header">
            <span><span class="card-header-icon">‚≠ê</span>XP Multipliers</span>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Global Multiplier (0.1x - 10.0x)</label>
              <input type="number" id="config-global-multiplier" class="form-control" min="0.1" max="10" step="0.1" value="1.0">
              <small style="color: var(--color-text-muted);">Applies to all XP awards</small>
            </div>

            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="config-gift-value-based"> Gift Value Based XP
              </label>
              <small style="display: block; color: var(--color-text-muted);">Calculate XP based on gift coin value</small>
            </div>

            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="config-gift-quantity-based"> Gift Quantity Based XP
              </label>
              <small style="display: block; color: var(--color-text-muted);">Consider gift quantity in XP calculation</small>
            </div>
          </div>
        </div>

        <!-- Rate Limits -->
        <div class="card">
          <div class="card-header">
            <span><span class="card-header-icon">üö¶</span>Rate Limiting</span>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="config-rate-limits-enabled"> Enable Rate Limiting
              </label>
            </div>

            <div class="form-group">
              <label class="form-label">Max XP per 5 Minutes</label>
              <input type="number" id="config-max-xp-5min" class="form-control" min="0" max="100000" step="100" value="10000">
            </div>

            <div class="form-group">
              <label class="form-label">Max XP per Hour</label>
              <input type="number" id="config-max-xp-hour" class="form-control" min="0" max="500000" step="1000" value="50000">
            </div>
          </div>
        </div>

        <!-- Event Caps -->
        <div class="card">
          <div class="card-header">
            <span><span class="card-header-icon">üõ°Ô∏è</span>Event Caps (Max XP per Event)</span>
          </div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
              <div class="form-group">
                <label class="form-label">Chat Message</label>
                <input type="number" id="config-cap-chat" class="form-control" min="1" max="1000" value="10">
              </div>
              <div class="form-group">
                <label class="form-label">Like</label>
                <input type="number" id="config-cap-like" class="form-control" min="1" max="1000" value="5">
              </div>
              <div class="form-group">
                <label class="form-label">Share</label>
                <input type="number" id="config-cap-share" class="form-control" min="1" max="1000" value="50">
              </div>
              <div class="form-group">
                <label class="form-label">Gift</label>
                <input type="number" id="config-cap-gift" class="form-control" min="1" max="50000" value="10000">
              </div>
              <div class="form-group">
                <label class="form-label">Follow</label>
                <input type="number" id="config-cap-follow" class="form-control" min="1" max="1000" value="100">
              </div>
              <div class="form-group">
                <label class="form-label">Subscribe</label>
                <input type="number" id="config-cap-subscribe" class="form-control" min="1" max="1000" value="200">
              </div>
            </div>
          </div>
        </div>

        <!-- Streak Configuration -->
        <div class="card">
          <div class="card-header">
            <span><span class="card-header-icon">üî•</span>Streak Bonuses</span>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">
                <input type="checkbox" id="config-streaks-enabled"> Enable Streak Bonuses
              </label>
            </div>

            <div class="form-group">
              <label class="form-label">Bonus Multiplier per Day (e.g., 1.1 = 10% bonus)</label>
              <input type="number" id="config-streak-multiplier" class="form-control" min="1.0" max="2.0" step="0.05" value="1.1">
            </div>

            <div class="form-group">
              <label class="form-label">Max Multiplier</label>
              <input type="number" id="config-streak-max" class="form-control" min="1.0" max="5.0" step="0.1" value="2.0">
            </div>
          </div>
        </div>

        <!-- Save Button -->
        <div class="card">
          <div class="card-body">
            <button id="config-save-btn" class="btn btn-primary btn-lg" style="width: 100%;">
              üíæ Save Configuration
            </button>
            <div id="config-save-status" style="margin-top: 12px; text-align: center;"></div>
          </div>
        </div>
      </div>

      <!-- NEW: Event Logs Page (v2.1.0) -->
      <div id="page-logs" class="tab-content">
        <div class="page-header">
          <h1 class="page-title">üìù Event Logs</h1>
          <p class="page-description">View and filter all XP events with full transparency</p>
        </div>

        <!-- Filters -->
        <div class="card">
          <div class="card-header">
            <span><span class="card-header-icon">üîç</span>Filters</span>
          </div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
              <div class="form-group">
                <label class="form-label">Username</label>
                <input type="text" id="logs-filter-username" class="form-control" placeholder="Filter by username...">
              </div>
              <div class="form-group">
                <label class="form-label">Event Type</label>
                <select id="logs-filter-type" class="form-select">
                  <option value="">All Types</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Time Period</label>
                <select id="logs-filter-period" class="form-select">
                  <option value="">All Time</option>
                  <option value="1h">Last Hour</option>
                  <option value="24h">Last 24 Hours</option>
                  <option value="7d">Last 7 Days</option>
                  <option value="30d">Last 30 Days</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Results per Page</label>
                <select id="logs-limit" class="form-select">
                  <option value="10">10</option>
                  <option value="25">25</option>
                  <option value="50" selected>50</option>
                  <option value="100">100</option>
                </select>
              </div>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 12px;">
              <button id="logs-apply-filter-btn" class="btn btn-primary">Apply Filters</button>
              <button id="logs-reset-filter-btn" class="btn btn-secondary">Reset</button>
              <button id="logs-export-btn" class="btn btn-success">üì• Export to JSON</button>
            </div>
          </div>
        </div>

        <!-- Events Table -->
        <div class="card">
          <div class="card-header">
            <span><span class="card-header-icon">üìä</span>Event History</span>
            <span id="logs-total-count" style="color: var(--color-text-muted); font-size: 0.875rem;">-</span>
          </div>
          <div class="card-body">
            <table class="modern-table">
              <thead>
                <tr>
                  <th>Time</th>
                  <th>User</th>
                  <th>Event Type</th>
                  <th>Amount</th>
                  <th>XP Awarded</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody id="logs-table-body">
                <tr>
                  <td colspan="6" style="text-align: center; padding: 40px;">Click "Apply Filters" to load events</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Pagination -->
        <div class="card">
          <div class="card-body">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <button id="logs-prev-btn" class="btn btn-secondary" disabled>‚Üê Previous</button>
              <span id="logs-page-info" style="color: var(--color-text-muted);">Page 1</span>
              <button id="logs-next-btn" class="btn btn-secondary" disabled>Next ‚Üí</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Page -->
      <div id="page-dashboard" class="tab-content active">
        <div class="page-header">
          <h1 class="page-title">üìä Dashboard</h1>
          <p class="page-description">Overview of viewer engagement and XP statistics</p>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-icon">üë•</span>
            </div>
            <div class="stat-card-value" id="totalViewers">-</div>
            <div class="stat-card-label">Total Viewers</div>
            <div class="stat-card-change positive" id="viewersChange" style="display:none;">
              +0 this week
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-icon">‚≠ê</span>
            </div>
            <div class="stat-card-value" id="totalXP">-</div>
            <div class="stat-card-label">Total XP Earned</div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-icon">üìä</span>
            </div>
            <div class="stat-card-value" id="avgLevel">-</div>
            <div class="stat-card-label">Average Level</div>
          </div>

          <div class="stat-card">
            <div class="stat-card-header">
              <span class="stat-card-icon">üî•</span>
            </div>
            <div class="stat-card-value" id="activeToday">-</div>
            <div class="stat-card-label">Active Today</div>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
          <div class="card-header">
            <span><span class="card-header-icon">‚ö°</span>Quick Actions</span>
          </div>
          <div class="card-body">
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
              <button class="btn btn-primary" data-action="navigateTo" data-arg="manual-award">
                üéÅ Award XP
              </button>
              <button class="btn btn-success" data-action="navigateTo" data-arg="obs-panel">
                üé¨ Setup OBS Overlays
              </button>
              <button class="btn btn-secondary" data-action="navigateTo" data-arg="import-export">
                üíæ Export Data
              </button>
              <button class="btn btn-secondary" data-action="refreshData">
                üîÑ Refresh Stats
              </button>
            </div>
          </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
          <div class="card-header">
            <span><span class="card-header-icon">üìà</span>Recent Activity</span>
            <select class="form-select" style="width: auto; padding: 6px 12px; font-size: 0.875rem;" id="activityFilter">
              <option value="all">All Activity</option>
              <option value="chat">Chat Messages</option>
              <option value="gift">Gifts</option>
              <option value="follow">Follows</option>
              <option value="level_up">Level Ups</option>
            </select>
          </div>
          <div class="card-body">
            <div id="recentActivityContainer">
              <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <div class="empty-state-text">No recent activity</div>
                <div class="empty-state-description">Activity will appear here as viewers interact</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Leaderboard Page -->
      <div id="page-leaderboard" class="tab-content">
        <div class="page-header">
          <h1 class="page-title">üèÜ Leaderboard</h1>
          <p class="page-description">Top viewers ranked by XP and engagement</p>
        </div>

        <div class="card">
          <div class="card-header">
            <span>Top Viewers</span>
            <div style="display: flex; gap: 12px; align-items: center;">
              <select class="form-select" style="width: auto; padding: 6px 12px; font-size: 0.875rem;" id="leaderboardFilter">
                <option value="">All Time</option>
                <option value="7">Last 7 Days</option>
                <option value="30">Last 30 Days</option>
              </select>
              <button class="btn btn-sm btn-secondary" data-action="refreshLeaderboard">
                üîÑ Refresh
              </button>
            </div>
          </div>
          <div class="card-body">
            <div class="search-box">
              <span class="search-icon">üîç</span>
              <input type="text" class="form-control" id="leaderboardSearch" placeholder="Search viewers...">
            </div>
            <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
              <table class="modern-table">
                <thead>
                  <tr>
                    <th style="width: 80px;">Rank</th>
                    <th>Username</th>
                    <th>Level</th>
                    <th>Title</th>
                    <th>XP</th>
                    <th>Progress</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="leaderboardTable">
                  <tr>
                    <td colspan="7">
                      <div class="empty-state">
                        <div class="empty-state-icon">üèÜ</div>
                        <div class="empty-state-text">Loading leaderboard...</div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- OBS Panel Page -->
      <div id="page-obs-panel" class="tab-content">
        <div class="page-header">
          <h1 class="page-title">üé¨ OBS Overlay Panel</h1>
          <p class="page-description">Setup and manage OBS Browser Source overlays</p>
        </div>

        <div class="alert alert-info">
          <span>üí°</span>
          <div>
            <strong>Quick Setup:</strong> Copy the URL below and add it as a Browser Source in OBS Studio. 
            Set width to 1920 and height according to your needs. Check "Shutdown source when not visible" for better performance.
          </div>
        </div>

        <!-- XP Bar Overlay -->
        <div class="overlay-card">
          <div class="overlay-card-title">
            ‚≠ê XP Bar Overlay
          </div>
          <p class="form-text" style="margin-bottom: 12px;">
            Displays real-time XP progress with animated level-ups and badges. Perfect for showing individual viewer progress.
          </p>
          
          <div class="overlay-url-box">
            <span class="url-text" id="xpBarUrl">http://localhost:3000/overlay/viewer-xp/xp-bar</span>
            <button class="btn btn-sm btn-primary copy-btn" data-action="copyToClipboard" data-arg="xpBarUrl">
              üìã Copy
            </button>
          </div>

          <div class="overlay-settings">
            <div class="form-group">
              <label class="form-label">Auto-Hide After (ms)</label>
              <input type="number" class="form-control" id="xpBarDuration" value="5000" min="1000" step="1000">
            </div>
            <div class="form-group">
              <label class="form-label">Show Profile Picture</label>
              <select class="form-select" id="xpBarShowPic">
                <option value="true">Yes</option>
                <option value="false">No</option>
              </select>
            </div>
          </div>

          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button class="btn btn-sm btn-success" data-action="updateOverlayUrl" data-arg="xpBar">
              ‚úÖ Update URL
            </button>
            <button class="btn btn-sm btn-secondary" data-action="testOverlay" data-arg="xp-bar">
              üëÅÔ∏è Test Overlay
            </button>
          </div>
        </div>

        <!-- Leaderboard Overlay -->
        <div class="overlay-card">
          <div class="overlay-card-title">
            üèÜ Leaderboard Overlay
          </div>
          <p class="form-text" style="margin-bottom: 12px;">
            Shows top viewers ranked by XP. Combines session and all-time stats with smooth animations.
          </p>
          
          <div class="overlay-url-box">
            <span class="url-text" id="leaderboardOverlayUrl">http://localhost:3000/overlay/viewer-xp/leaderboard</span>
            <button class="btn btn-sm btn-primary copy-btn" data-action="copyToClipboard" data-arg="leaderboardOverlayUrl">
              üìã Copy
            </button>
          </div>

            <div class="overlay-settings">
              <div class="form-group">
                <label class="form-label">Number of Entries</label>
                <input type="number" class="form-control" id="leaderboardLimit" value="10" min="3" max="50">
              </div>
            <div class="form-group">
              <label class="form-label">Time Period</label>
              <select class="form-select" id="leaderboardDays">
                <option value="">All Time</option>
                <option value="7">Last 7 Days</option>
                <option value="30">Last 30 Days</option>
              </select>
            </div>
            <div class="form-group">
                <label class="form-label">Refresh Interval (ms)</label>
                <input type="number" class="form-control" id="leaderboardRefresh" value="30000" min="5000" step="5000">
              </div>
              <div class="form-group">
                <label class="form-label">Design Theme</label>
                <select class="form-select" id="leaderboardTheme">
                  <option value="">Standard</option>
                  <option value="minimal">Minimal</option>
                  <option value="transparent">Transparent</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Accent Color</label>
                <input type="color" class="form-control" id="leaderboardAccent" value="#ffd700">
              </div>
              <div class="form-group">
                <label class="form-label">Font Family</label>
                <input type="text" class="form-control" id="leaderboardFont" placeholder="e.g. 'Inter', sans-serif">
              </div>
            </div>

          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button class="btn btn-sm btn-success" data-action="updateOverlayUrl" data-arg="leaderboard">
              ‚úÖ Update URL
            </button>
            <button class="btn btn-sm btn-secondary" data-action="testOverlay" data-arg="leaderboard">
              üëÅÔ∏è Test Overlay
            </button>
          </div>
        </div>

        <!-- Level-Up Animation Overlay -->
        <div class="overlay-card">
          <div class="overlay-card-title">
            üéâ Level-Up Animation Overlay
          </div>
          <p class="form-text" style="margin-bottom: 12px;">
            Celebration animation when viewers level up. Shows confetti, new level, and unlocked rewards.
          </p>
          
          <div class="overlay-url-box">
            <span class="url-text" id="levelUpUrl">http://localhost:3000/overlay/viewer-xp/level-up</span>
            <button class="btn btn-sm btn-primary copy-btn" data-action="copyToClipboard" data-arg="levelUpUrl">
              üìã Copy
            </button>
          </div>

            <div class="overlay-settings">
              <div class="form-group">
                <label class="form-label">Animation Duration (ms)</label>
                <input type="number" class="form-control" id="levelUpDuration" value="5000" min="2000" step="1000">
              </div>
              <div class="form-group">
                <label class="form-label">Enable Sound</label>
                <select class="form-select" id="levelUpSound">
                  <option value="true">Yes</option>
                  <option value="false">No</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Show Animation From Level</label>
                <input type="number" class="form-control" id="levelUpMinLevel" value="1" min="1" step="1">
                <small class="form-text">Hide frequent low-level spam by setting a minimum level.</small>
              </div>
            </div>

          <div style="display: flex; gap: 12px; margin-top: 16px;">
            <button class="btn btn-sm btn-success" data-action="updateOverlayUrl" data-arg="levelUp">
              ‚úÖ Update URL
            </button>
            <button class="btn btn-sm btn-secondary" data-action="testOverlay" data-arg="level-up">
              üëÅÔ∏è Test Overlay
            </button>
          </div>
        </div>

        <!-- OBS Setup Guide -->
        <div class="card">
          <div class="card-header">
            <span class="card-header-icon">üìñ</span> OBS Setup Guide
          </div>
          <div class="card-body">
            <ol style="line-height: 1.8; color: var(--color-text-secondary);">
              <li>Open OBS Studio</li>
              <li>Click the <strong>+</strong> button in the Sources panel</li>
              <li>Select <strong>Browser</strong> from the list</li>
              <li>Give it a name (e.g., "XP Bar", "Leaderboard")</li>
              <li>Paste the URL from above into the <strong>URL</strong> field</li>
              <li>Set <strong>Width</strong> to 1920 and <strong>Height</strong> according to your overlay needs</li>
              <li>Check <strong>"Shutdown source when not visible"</strong> for better performance</li>
              <li>Click <strong>OK</strong> to add the overlay to your scene</li>
              <li>Resize and position as needed in your scene</li>
            </ol>
            <div class="alert alert-warning" style="margin-top: 16px;">
              <span>‚ö†Ô∏è</span>
              <div>
                <strong>Important:</strong> The overlays require an active connection to the server. 
                Make sure the server is running before starting your stream.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Additional pages will be loaded here -->
      <div id="page-overlay-preview" class="tab-content">
        <div class="page-header">
          <h1 class="page-title">üëÅÔ∏è Live Preview</h1>
          <p class="page-description">Preview how overlays look before adding them to OBS</p>
        </div>

        <!-- Overlay Selection -->
        <div class="card">
          <div class="card-header">
            <span><span class="card-header-icon">üé®</span>Select Overlay</span>
          </div>
          <div class="card-body">
            <div class="form-group" style="max-width: 500px;">
              <label class="form-label">Choose Overlay to Preview</label>
              <select class="form-control" id="overlaySelect" onchange="loadOverlayPreview()">
                <option value="">-- Select an Overlay --</option>
                <option value="xp-bar">XP Bar - Shows current viewer's XP progress</option>
                <option value="leaderboard">Leaderboard - Top viewers ranking</option>
                <option value="level-up">Level Up - Level up celebration animation</option>
                <option value="user-profile">User Profile - Detailed viewer stats card</option>
              </select>
            </div>

            <div class="form-group" style="max-width: 300px; margin-top: 16px;">
              <label class="form-label">Preview Scale</label>
              <select class="form-control" id="previewScale" onchange="updatePreviewScale()">
                <option value="0.5">50% (Small)</option>
                <option value="0.75">75% (Medium)</option>
                <option value="1" selected>100% (Full Size)</option>
              </select>
            </div>

            <div style="margin-top: 16px;">
              <button class="btn btn-success" data-action="refreshPreview">
                üîÑ Refresh Preview
              </button>
              <button class="btn btn-secondary" data-action="copyOverlayURL">
                üìã Copy OBS URL
              </button>
            </div>

            <div id="overlayURL" style="margin-top: 12px; display: none;">
              <label class="form-label">OBS Browser Source URL:</label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="text" class="form-control" id="overlayURLInput" readonly 
                  style="font-family: monospace; font-size: 0.9rem;">
                <button class="btn btn-sm btn-secondary" data-action="copyToClipboard" data-source-id="overlayURLInput">
                  üìã Copy
                </button>
              </div>
              <small class="form-text">Add this URL as a Browser Source in OBS</small>
            </div>
          </div>
        </div>

        <!-- Preview Container -->
        <div class="card" id="previewCard" style="display: none;">
          <div class="card-header">
            <span><span class="card-header-icon">üëÅÔ∏è</span>Live Preview</span>
          </div>
          <div class="card-body" style="background: #1a1a1a; min-height: 400px; display: flex; align-items: center; justify-content: center;">
            <div id="previewContainer" style="width: 100%; height: 100%; position: relative; transform-origin: top left;">
              <iframe id="previewFrame" style="width: 100%; height: 600px; border: none; background: transparent;"></iframe>
            </div>
          </div>
        </div>

        <!-- Test Controls -->
        <div class="card" id="testControls" style="display: none;">
          <div class="card-header">
            <span><span class="card-header-icon">üéÆ</span>Test Controls</span>
          </div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
              <button class="btn btn-primary" data-action="testLevelUp">
                ‚¨ÜÔ∏è Test Level Up
              </button>
              <button class="btn btn-primary" data-action="testXPGain">
                ‚≠ê Test XP Gain
              </button>
              <button class="btn btn-primary" data-action="refreshLeaderboardPreview">
                üìä Refresh Leaderboard
              </button>
              <button class="btn btn-primary" data-action="testUserProfile">
                üë§ Test User Profile
              </button>
            </div>
            <div style="margin-top: 16px;">
              <label class="form-label">Test Username</label>
              <input type="text" class="form-control" id="testUsername" placeholder="Enter username for testing" 
                style="max-width: 300px;">
            </div>
          </div>
        </div>
      </div>

      <div id="page-xp-settings" class="tab-content">
        <div class="page-header">
          <h1 class="page-title">‚öôÔ∏è XP Settings</h1>
          <p class="page-description">Configure XP rewards for viewer actions</p>
        </div>

        <!-- XP Actions Configuration -->
        <div class="card">
          <div class="card-header">
            <span><span class="card-header-icon">‚ö°</span>XP Action Configuration</span>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="modern-table">
                <thead>
                  <tr>
                    <th>Action Type</th>
                    <th>XP Amount</th>
                    <th>Cooldown (seconds)</th>
                    <th>Enabled</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="actionsTable">
                  <tr>
                    <td colspan="5">
                      <div class="empty-state">
                        <div class="empty-state-icon">‚öôÔ∏è</div>
                        <div class="empty-state-text">Loading actions...</div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- General Settings -->
        <div class="card">
          <div class="card-header">
            <span><span class="card-header-icon">üéõÔ∏è</span>General Settings</span>
          </div>
          <div class="card-body">
            <form id="generalSettingsForm">
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;">
                <div>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="enableDailyBonus" checked>
                    <label class="form-check-label" for="enableDailyBonus">
                      <strong>Enable Daily Bonus</strong>
                      <div class="form-text">Award XP to viewers on their first visit each day</div>
                    </label>
                  </div>
                  
                  <div class="form-check" style="margin-top: 16px;">
                    <input type="checkbox" class="form-check-input" id="enableStreaks" checked>
                    <label class="form-check-label" for="enableStreaks">
                      <strong>Enable Streaks</strong>
                      <div class="form-text">Reward viewers for consecutive daily visits</div>
                    </label>
                  </div>
                  
                  <div class="form-check" style="margin-top: 16px;">
                    <input type="checkbox" class="form-check-input" id="enableWatchTime" checked>
                    <label class="form-check-label" for="enableWatchTime">
                      <strong>Enable Watch Time XP</strong>
                      <div class="form-text">Award XP based on viewing duration</div>
                    </label>
                  </div>
                </div>

                <div>
                  <div class="form-group">
                    <label class="form-label">Watch Time Interval (minutes)</label>
                    <input type="number" class="form-control" id="watchTimeInterval" min="1" max="60" value="5">
                    <small class="form-text">Award XP every X minutes of watching</small>
                  </div>
                  
                  <div class="form-check" style="margin-top: 16px;">
                    <input type="checkbox" class="form-check-input" id="announceLevelUps" checked>
                    <label class="form-check-label" for="announceLevelUps">
                      <strong>Announce Level Ups</strong>
                      <div class="form-text">Show notifications when viewers level up</div>
                    </label>
                  </div>
                </div>
              </div>

              <div style="margin-top: 24px;">
                <button type="submit" class="btn btn-success">
                  üíæ Save Settings
                </button>
                <button type="button" class="btn btn-secondary" data-action="resetSettings">
                  üîÑ Reset to Defaults
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div id="page-level-config" class="tab-content">
        <div class="page-header">
          <h1 class="page-title">üìà Level Configuration</h1>
          <p class="page-description">Customize level progression and rewards</p>
        </div>

        <!-- Progression Type Selection -->
        <div class="card">
          <div class="card-header">
            <span><span class="card-header-icon">‚öôÔ∏è</span>Progression Type</span>
          </div>
          <div class="card-body">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
              <div class="form-check">
                <input type="radio" class="form-check-input" name="levelType" id="levelTypeExponential" 
                  value="exponential" checked onchange="updateLevelTypeSettings()">
                <label class="form-check-label" for="levelTypeExponential">
                  <strong>Exponential</strong>
                  <div class="form-text">XP required increases exponentially (Level 1: 0 XP, Level 2: 100 XP, Level 3: 400 XP, Level 4: 900 XP)</div>
                </label>
              </div>
              
              <div class="form-check">
                <input type="radio" class="form-check-input" name="levelType" id="levelTypeLinear" 
                  value="linear" onchange="updateLevelTypeSettings()">
                <label class="form-check-label" for="levelTypeLinear">
                  <strong>Linear</strong>
                  <div class="form-text">Fixed XP per level (e.g., 1000 XP per level)</div>
                </label>
              </div>
              
              <div class="form-check">
                <input type="radio" class="form-check-input" name="levelType" id="levelTypeCustom" 
                  value="custom" onchange="updateLevelTypeSettings()">
                <label class="form-check-label" for="levelTypeCustom">
                  <strong>Custom</strong>
                  <div class="form-text">Define custom XP requirements for each level</div>
                </label>
              </div>
            </div>

            <div id="linearSettings" style="display: none; margin-top: 16px; max-width: 400px;">
              <div class="form-group">
                <label class="form-label">XP Per Level</label>
                <input type="number" class="form-control" id="xpPerLevel" value="1000" min="100">
                <small class="form-text">XP required to advance one level</small>
              </div>
            </div>

            <div style="margin-top: 16px;">
              <button class="btn btn-success" data-action="saveLevelTypeSettings">
                üíæ Save Progression Settings
              </button>
            </div>
          </div>
        </div>

        <!-- Level Generator -->
        <div class="card" id="levelGeneratorCard">
          <div class="card-header">
            <span><span class="card-header-icon">üîß</span>Level Generator</span>
          </div>
          <div class="card-body">
            <p style="margin-bottom: 16px;">Generate custom level configurations with automatic rewards</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
              <div class="form-group">
                <label class="form-label">Number of Levels</label>
                <input type="number" class="form-control" id="genLevelCount" value="100" min="10" max="999">
              </div>
              
              <div class="form-group">
                <label class="form-label">Starting XP</label>
                <input type="number" class="form-control" id="genStartXP" value="100" min="0">
              </div>
              
              <div class="form-group">
                <label class="form-label">Growth Rate</label>
                <select class="form-control" id="genGrowthRate">
                  <option value="slow">Slow (1.1x per level)</option>
                  <option value="medium" selected>Medium (1.2x per level)</option>
                  <option value="fast">Fast (1.5x per level)</option>
                  <option value="extreme">Extreme (2.0x per level)</option>
                </select>
              </div>
            </div>

            <div style="margin-top: 16px;">
              <button class="btn btn-primary" data-action="generateLevelConfigs">
                üé≤ Generate Levels
              </button>
              <button class="btn btn-secondary" data-action="previewLevelProgression">
                üìä Preview Progression
              </button>
            </div>

            <div id="levelProgressionPreview" style="display: none; margin-top: 16px; max-height: 300px; overflow-y: auto;">
              <h4 style="font-size: 1rem; margin-bottom: 12px;">Progression Preview</h4>
              <div class="table-responsive">
                <table class="modern-table" style="font-size: 0.85rem;">
                  <thead>
                    <tr>
                      <th>Level</th>
                      <th>Total XP Required</th>
                      <th>XP for Next Level</th>
                      <th>Growth</th>
                    </tr>
                  </thead>
                  <tbody id="progressionPreviewTable">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Level Rewards Configuration -->
        <div class="card">
          <div class="card-header">
            <span><span class="card-header-icon">üéÅ</span>Level Rewards</span>
          </div>
          <div class="card-body">
            <div style="margin-bottom: 16px;">
              <button class="btn btn-primary" data-action="addLevelReward">
                ‚ûï Add Reward Tier
              </button>
              <button class="btn btn-secondary" data-action="loadLevelRewards">
                üîÑ Refresh
              </button>
            </div>

            <div class="table-responsive">
              <table class="modern-table">
                <thead>
                  <tr>
                    <th>Level</th>
                    <th>Title/Badge</th>
                    <th>Name Color</th>
                    <th>Custom Emote</th>
                    <th>Announcement</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="levelRewardsTable">
                  <tr>
                    <td colspan="6">
                      <div class="empty-state">
                        <div class="empty-state-icon">üéÅ</div>
                        <div class="empty-state-text">No rewards configured yet</div>
                        <div class="empty-state-description">Add milestone rewards for reaching specific levels</div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Current Level Distribution -->
        <div class="card">
          <div class="card-header">
            <span><span class="card-header-icon">üìä</span>Level Distribution</span>
          </div>
          <div class="card-body">
            <div id="levelDistributionChart" style="min-height: 200px;">
              <div class="empty-state">
                <div class="empty-state-icon">üìä</div>
                <div class="empty-state-text">Level distribution chart</div>
                <div class="empty-state-description">Shows how many viewers are at each level range</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="page-manual-award" class="tab-content">
        <div class="page-header">
          <h1 class="page-title">üéÅ Manual Award</h1>
          <p class="page-description">Manually award XP to viewers for special events or achievements</p>
        </div>

        <div class="card" style="max-width: 600px;">
          <div class="card-header">
            <span><span class="card-header-icon">üéÅ</span>Award XP</span>
          </div>
          <div class="card-body">
            <div class="alert alert-info">
              <span>üí°</span>
              <div>
                <strong>Tip:</strong> Use this to reward viewers for special contributions, milestones, or community events.
                The XP will be added immediately and a level-up animation will trigger if they reach a new level.
              </div>
            </div>

            <form id="manualAwardForm">
              <div class="form-group">
                <label class="form-label">Username *</label>
                <input type="text" class="form-control" id="awardUsername" placeholder="Enter viewer username" list="viewerSuggestions" autocomplete="off" required>
                <datalist id="viewerSuggestions"></datalist>
                <small class="form-text">The TikTok username of the viewer to award XP</small>
              </div>

              <div class="form-group">
                <label class="form-label">XP Amount *</label>
                <input type="number" class="form-control" id="awardAmount" min="1" placeholder="100" required>
                <small class="form-text">Amount of XP to award (minimum: 1)</small>
              </div>

              <div class="form-group">
                <label class="form-label">Reason (Optional)</label>
                <textarea class="form-control" id="awardReason" rows="3" placeholder="e.g., Winner of community event, Milestone celebration, etc."></textarea>
                <small class="form-text">Optional note about why this XP was awarded (for your records)</small>
              </div>

              <div style="display: flex; gap: 12px;">
                <button type="submit" class="btn btn-success">
                  ‚úÖ Award XP
                </button>
                <button type="button" class="btn btn-secondary" data-action="clearAwardForm">
                  üîÑ Clear Form
                </button>
              </div>

              <div id="awardResult" style="margin-top: 16px;"></div>
            </form>
          </div>
        </div>

        <!-- Recent Manual Awards -->
        <div class="card" style="margin-top: 24px;">
          <div class="card-header">
            <span><span class="card-header-icon">üìú</span>Recent Manual Awards</span>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="modern-table">
                <thead>
                  <tr>
                    <th>Date/Time</th>
                    <th>Username</th>
                    <th>XP Amount</th>
                    <th>Reason</th>
                  </tr>
                </thead>
                <tbody id="recentAwardsTable">
                  <tr>
                    <td colspan="4">
                      <div class="empty-state">
                        <div class="empty-state-icon">üìú</div>
                        <div class="empty-state-text">No manual awards yet</div>
                        <div class="empty-state-description">Recent manual XP awards will appear here</div>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Spin Wheel Settings Page -->
      <div id="page-spin-settings" class="tab-content">
        <div class="page-header">
          <h1 class="page-title">üé∞ Spin Wheel Settings</h1>
          <p class="page-description">Configure the lucky wheel game for viewers</p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr; gap: 24px;">
          <!-- Spin Configuration -->
          <div class="card">
            <div class="card-header">
              <span><span class="card-header-icon">‚öôÔ∏è</span>Wheel Configuration</span>
            </div>
            <div class="card-body">
              <form id="spinConfigForm">
                <div class="form-group">
                  <label class="form-label">
                    <input type="checkbox" id="spinEnabled"> Enable Spin Wheel
                  </label>
                  <small class="form-text">Allow viewers to use the /spin command</small>
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label class="form-label">Minimum Bet (XP)</label>
                    <input type="number" class="form-control" id="spinMinBet" min="1" placeholder="100">
                    <small class="form-text">Smallest amount viewers can bet</small>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Maximum Bet (XP)</label>
                    <input type="number" class="form-control" id="spinMaxBet" min="1" placeholder="50000">
                    <small class="form-text">Largest amount viewers can bet</small>
                  </div>

                  <div class="form-group">
                    <label class="form-label">Default Bet (XP)</label>
                    <input type="number" class="form-control" id="spinDefaultBet" min="1" placeholder="1000">
                    <small class="form-text">Default bet when using /spin without amount</small>
                  </div>
                </div>

                <div class="form-group">
                  <label class="form-label">Number of Fields</label>
                  <input type="number" class="form-control" id="spinNumFields" min="4" max="16" value="8">
                  <small class="form-text">How many segments on the wheel (4-16)</small>
                </div>

                <div class="form-group">
                  <label class="form-label">Field Values (XP)</label>
                  <small class="form-text" style="display: block; margin-bottom: 8px;">
                    Enter XP values for each field (positive = win, negative = lose). One per line.
                  </small>
                  <textarea class="form-control" id="spinFieldValues" rows="8" placeholder="5000&#10;-2000&#10;1000&#10;-5000&#10;2000&#10;-1000&#10;10000&#10;-3000"></textarea>
                  <small class="form-text">Tip: Use large positive values for jackpots, negative values for risk</small>
                </div>

                <div class="alert alert-info">
                  <span>üí°</span>
                  <div>
                    <strong>How it works:</strong><br>
                    ‚Ä¢ Viewers use /spin to bet the default amount or /spin &lt;amount&gt; to bet a custom amount<br>
                    ‚Ä¢ They spin the wheel and land on a random field<br>
                    ‚Ä¢ Positive fields = win that amount of XP<br>
                    ‚Ä¢ Negative fields = lose that amount of XP (plus their bet)<br>
                    ‚Ä¢ Example: Bet 5000, land on +10000 = net gain +5000 XP<br>
                    ‚Ä¢ Example: Bet 5000, land on -2000 = net loss -7000 XP
                  </div>
                </div>

                <button type="submit" class="btn btn-primary" id="saveSpinConfigBtn">
                  üíæ Save Spin Configuration
                </button>
              </form>
            </div>
          </div>

          <!-- Wheel Preview -->
          <div class="card">
            <div class="card-header">
              <span><span class="card-header-icon">üëÅÔ∏è</span>Wheel Preview</span>
            </div>
            <div class="card-body">
              <div id="wheelPreviewContainer" style="text-align: center; padding: 20px;">
                <div style="display: inline-block; position: relative;">
                  <canvas id="wheelPreviewCanvas" width="300" height="300" style="border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.3);"></canvas>
                </div>
                <p style="margin-top: 16px; color: var(--color-text-secondary);">
                  Preview updates automatically when you change field values
                </p>
              </div>
            </div>
          </div>

          <!-- Spin History -->
          <div class="card">
            <div class="card-header">
              <span><span class="card-header-icon">üìä</span>Recent Spins</span>
              <button type="button" class="btn btn-secondary" id="refreshSpinHistoryBtn">
                üîÑ Refresh
              </button>
            </div>
            <div class="card-body">
              <div id="spinHistoryContainer">
                <div class="empty-state">
                  <div class="empty-state-icon">üé∞</div>
                  <div class="empty-state-text">No spin history yet</div>
                  <div class="empty-state-description">Spins will appear here once viewers start playing</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Spin Statistics -->
          <div class="card">
            <div class="card-header">
              <span><span class="card-header-icon">üìà</span>Statistics</span>
            </div>
            <div class="card-body">
              <div id="spinStatsContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div class="stat-box">
                  <div class="stat-label">Total Spins</div>
                  <div class="stat-value" id="statTotalSpins">0</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Total Wins</div>
                  <div class="stat-value" id="statWins">0</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Total Losses</div>
                  <div class="stat-value" id="statLosses">0</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Net XP Change</div>
                  <div class="stat-value" id="statNetChange">0</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Biggest Win</div>
                  <div class="stat-value" id="statBiggestWin">0</div>
                </div>
                <div class="stat-box">
                  <div class="stat-label">Biggest Loss</div>
                  <div class="stat-value" id="statBiggestLoss">0</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="page-import-export" class="tab-content">
        <div class="page-header">
          <h1 class="page-title">üíæ Import/Export</h1>
          <p class="page-description">Backup and restore viewer data</p>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
          <!-- Export Section -->
          <div class="card">
            <div class="card-header">
              <span><span class="card-header-icon">üì§</span>Export Data</span>
            </div>
            <div class="card-body">
              <p style="color: var(--color-text-secondary); margin-bottom: 16px;">
                Export all viewer XP data including profiles, transactions, and configuration settings.
                This creates a JSON backup file you can use to restore data later.
              </p>
              
              <div class="alert alert-info">
                <span>üí°</span>
                <div>
                  <strong>What's included:</strong>
                  <ul style="margin: 8px 0 0 20px; line-height: 1.6;">
                    <li>All viewer profiles and XP data</li>
                    <li>Transaction history</li>
                    <li>Level configuration</li>
                    <li>XP action settings</li>
                  </ul>
                </div>
              </div>

              <button type="button" class="btn btn-success" id="exportDataBtn" data-action="exportData">
                üì• Download Export File
              </button>
              <div id="exportStatus" style="margin-top: 16px;"></div>
            </div>
          </div>

          <!-- Import Section -->
          <div class="card">
            <div class="card-header">
              <span><span class="card-header-icon">üì•</span>Import Data</span>
            </div>
            <div class="card-body">
              <p style="color: var(--color-text-secondary); margin-bottom: 16px;">
                Import viewer XP data from a previously exported file. 
                Existing data will be merged with imported data.
              </p>

              <div class="alert alert-warning">
                <span>‚ö†Ô∏è</span>
                <div>
                  <strong>Warning:</strong> Importing data will update existing viewer profiles with the same username.
                  Make sure to back up your current data before importing.
                </div>
              </div>

              <div class="form-group">
                <label class="form-label">Select Export File</label>
                <input type="file" class="form-control" id="importFile" accept=".json">
                <small class="form-text">Choose a JSON file exported from this system</small>
              </div>

              <button type="button" class="btn btn-warning" id="importDataBtn" data-action="importData">
                üì§ Import Data
              </button>
              <div id="importStatus" style="margin-top: 16px;"></div>
            </div>
          </div>
        </div>

        <!-- Viewer History Lookup -->
        <div class="card" style="margin-top: 24px;">
          <div class="card-header">
            <span><span class="card-header-icon">üìä</span>Viewer XP History</span>
          </div>
          <div class="card-body">
            <div class="form-group" style="max-width: 500px;">
              <label class="form-label">Search Viewer</label>
              <div style="display: flex; gap: 12px;">
                <input type="text" class="form-control" id="historyUsername" placeholder="Enter username">
                <button class="btn btn-primary" data-action="loadViewerHistory" style="white-space: nowrap;">
                  üîç Load History
                </button>
              </div>
            </div>

            <div id="historyContainer" style="display:none; margin-top: 24px;">
              <h3 style="font-size: 1.125rem; margin-bottom: 16px;">
                Transaction History for <strong id="historyViewerName"></strong>
              </h3>
              <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                <table class="modern-table">
                  <thead>
                    <tr>
                      <th>Date/Time</th>
                      <th>Action Type</th>
                      <th>XP Amount</th>
                      <th>Details</th>
                    </tr>
                  </thead>
                  <tbody id="historyTable">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="/js/vendor/bootstrap.bundle.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  
  <script>
    // Navigation System
    function navigateTo(pageName) {
      // Hide all pages
      document.querySelectorAll('.tab-content').forEach(page => {
        page.classList.remove('active');
      });

      // Remove active class from all nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
      });

      // Show selected page
      const targetPage = document.getElementById(`page-${pageName}`);
      if (targetPage) {
        targetPage.classList.add('active');
      }

      // Activate nav item
      const navItem = document.querySelector(`.nav-item[data-page="${pageName}"]`);
      if (navItem) {
        navItem.classList.add('active');
      }

      // Load page-specific data
      loadPageData(pageName);
    }

    // Setup nav click handlers
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const pageName = item.getAttribute('data-page');
        navigateTo(pageName);
      });
    });

    // Copy to clipboard
    function copyToClipboard(elementId) {
      const element = document.getElementById(elementId);
      const text = element.textContent;
      
      navigator.clipboard.writeText(text).then(() => {
        // Show success feedback
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '‚úÖ Copied!';
        btn.style.background = 'var(--color-accent-success)';
        
        setTimeout(() => {
          btn.innerHTML = originalText;
          btn.style.background = '';
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy:', err);
        alert('Failed to copy to clipboard');
      });
    }

    // Update overlay URL with parameters
    function updateOverlayUrl(overlayType) {
      const baseUrls = {
        xpBar: '/overlay/viewer-xp/xp-bar',
        leaderboard: '/overlay/viewer-xp/leaderboard',
        levelUp: '/overlay/viewer-xp/level-up'
      };

      const params = {};
      
      if (overlayType === 'xpBar') {
        params.duration = document.getElementById('xpBarDuration').value;
        params.showPic = document.getElementById('xpBarShowPic').value;
        params.autoHide = 'true';
      } else if (overlayType === 'leaderboard') {
        const limit = document.getElementById('leaderboardLimit').value;
        const days = document.getElementById('leaderboardDays').value;
        const refresh = document.getElementById('leaderboardRefresh').value;
        const theme = document.getElementById('leaderboardTheme').value;
        const accent = document.getElementById('leaderboardAccent').value;
        const font = document.getElementById('leaderboardFont').value;
        
        if (limit) params.limit = limit;
        if (days) params.days = days;
        if (refresh) params.refresh = refresh;
        if (theme) params.theme = theme;
        if (accent) params.accent = accent;
        if (font) params.font = font;
      } else if (overlayType === 'levelUp') {
        params.duration = document.getElementById('levelUpDuration').value;
        params.sound = document.getElementById('levelUpSound').value;
        const minLevel = document.getElementById('levelUpMinLevel').value;
        if (minLevel) params.minLevel = minLevel;
      }

      const urlBase = window.location.origin + baseUrls[overlayType];
      const queryString = Object.keys(params).length > 0 
        ? '?' + Object.entries(params).map(([k, v]) => `${k}=${v}`).join('&')
        : '';
      
      const fullUrl = urlBase + queryString;
      
      const urlElementIds = {
        xpBar: 'xpBarUrl',
        leaderboard: 'leaderboardOverlayUrl',
        levelUp: 'levelUpUrl'
      };
      
      document.getElementById(urlElementIds[overlayType]).textContent = fullUrl;
      
      // Show success message
      alert('‚úÖ URL updated! Copy it to use in OBS.');
    }

    // Test overlay in new window
    function testOverlay(overlayName) {
      const url = window.location.origin + `/overlay/viewer-xp/${overlayName}?test=true`;
      window.open(url, '_blank', 'width=1920,height=1080');
    }

    // Refresh data functions
    function refreshData() {
      loadPageData('dashboard');
    }

    function refreshLeaderboard() {
      loadPageData('leaderboard');
    }

    // Load page-specific data
    async function loadPageData(pageName) {
      if (pageName === 'overview') {
        loadOverviewPage();
      } else if (pageName === 'user-detail') {
        // User detail loads on demand via search
      } else if (pageName === 'config') {
        loadConfigPage();
      } else if (pageName === 'logs') {
        loadEventTypesForLogs();
      } else if (pageName === 'dashboard') {
        loadDashboardStats();
      } else if (pageName === 'leaderboard') {
        loadLeaderboard();
      } else if (pageName === 'xp-settings') {
        loadXPSettings();
      } else if (pageName === 'level-config') {
        loadLevelConfig();
        loadLevelRewards();
      } else if (pageName === 'manual-award') {
        loadRecentAwards();
      }
    }

    // Load dashboard statistics
    async function loadDashboardStats() {
      try {
        const response = await fetch('/api/viewer-xp/stats');
        const data = await response.json();
        
        const totalViewers = data.totalViewers ?? data.total_viewers ?? 0;
        const totalXP = data.totalXPEarned ?? data.total_xp ?? 0;
        const avgLevel = data.avgLevel ?? data.average_level ?? 0;
        const activeToday = data.activeToday ?? data.active_today ?? 0;

        document.getElementById('totalViewers').textContent = totalViewers.toLocaleString();
        document.getElementById('totalXP').textContent = formatNumber(totalXP);
        document.getElementById('avgLevel').textContent = Number(avgLevel).toFixed(1);
        document.getElementById('activeToday').textContent = activeToday.toLocaleString();
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load leaderboard
    async function loadLeaderboard() {
      try {
        const filter = document.getElementById('leaderboardFilter').value;
        const url = filter 
          ? `/api/viewer-xp/leaderboard?limit=50&days=${filter}`
          : '/api/viewer-xp/leaderboard?limit=50';
        
        const response = await fetch(url);
        const data = await response.json();
        const leaderboard = Array.isArray(data) ? data : (data.leaderboard || []);
        
        const tbody = document.getElementById('leaderboardTable');
        
        if (!leaderboard || leaderboard.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7">
                <div class="empty-state">
                  <div class="empty-state-icon">üèÜ</div>
                  <div class="empty-state-text">No viewers yet</div>
                  <div class="empty-state-description">Viewers will appear here as they earn XP</div>
                </div>
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = leaderboard.map((viewer, index) => {
          const rank = index + 1;
          const rankClass = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : 'rank-default';
          const rankIcon = rank === 1 ? 'üëë' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;
          
          const progress = typeof viewer.xp_progress_percent === 'number'
            ? viewer.xp_progress_percent
            : (
              viewer.xp_progress && viewer.xp_for_next_level
                ? (viewer.xp_progress / viewer.xp_for_next_level) * 100
                : 0
            );
          const xpValue = viewer.xp_period ?? viewer.xp ?? 0;
          
          return `
            <tr>
              <td>
                <div class="rank-indicator ${rankClass}">${rankIcon}</div>
              </td>
              <td><strong>${escapeHtml(viewer.username)}</strong></td>
              <td><span class="badge badge-level">Lvl ${viewer.level}</span></td>
              <td><span class="badge badge-primary">${escapeHtml(viewer.title || 'Newcomer')}</span></td>
              <td><strong>${formatNumber(xpValue)}</strong> XP</td>
              <td style="min-width: 200px;">
                <div class="xp-progress">
                  <div class="xp-progress-fill" style="width: ${Math.min(Math.max(progress, 0), 100)}%"></div>
                </div>
                <small class="form-text">${Number(progress).toFixed(1)}% to next level</small>
              </td>
              <td>
                <button class="btn btn-sm btn-secondary" data-action="viewUserDetails" data-arg="${escapeHtml(viewer.username)}">
                  View
                </button>
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading leaderboard:', error);
      }
    }

    // View user details
    function viewUserDetails(username) {
      // TODO: Implement user details modal
      // For now, show a friendly message
      const message = document.createElement('div');
      message.className = 'alert alert-info';
      message.style.position = 'fixed';
      message.style.top = '20px';
      message.style.right = '20px';
      message.style.zIndex = '9999';
      message.style.maxWidth = '400px';
      message.innerHTML = `
        <span>üí°</span>
        <div>
          <strong>Coming Soon!</strong><br>
          Detailed viewer profile for ${escapeHtml(username)} will be available in the next update.
        </div>
      `;
      document.body.appendChild(message);
      
      setTimeout(() => {
        message.style.transition = 'opacity 0.3s';
        message.style.opacity = '0';
        setTimeout(() => message.remove(), 300);
      }, 3000);
    }

    // Utility functions
    function formatNumber(num) {
      const absValue = Math.abs(num);
      const sign = num < 0 ? '-' : '';
      
      if (absValue >= 1000000) {
        const millions = absValue / 1000000;
        if (millions >= 10) {
          return sign + Math.floor(millions) + 'M';
        } else {
          return sign + millions.toFixed(1) + 'M';
        }
      } else if (absValue >= 1000) {
        return sign + Math.floor(absValue / 1000) + 'k';
      }
      return num.toString();
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadPageData('dashboard');
      
      // Setup leaderboard filter
      document.getElementById('leaderboardFilter')?.addEventListener('change', refreshLeaderboard);
      
      // Setup search
      document.getElementById('leaderboardSearch')?.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#leaderboardTable tr');
        
        rows.forEach(row => {
          const username = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
          row.style.display = username.includes(searchTerm) ? '' : 'none';
        });
      });
    });

    // Socket.io connection for live updates
    const socket = io();
    
    socket.on('viewer-xp:update', (data) => {
      // Refresh dashboard when XP is updated
      if (document.getElementById('page-dashboard').classList.contains('active')) {
        refreshData();
      }
    });

    socket.on('viewer-xp:level-up', (data) => {
      // Show toast notification for level ups
      if (data && data.username && data.newLevel) {
        showToast(`üéâ ${data.username} leveled up to Level ${data.newLevel}!`, 'success');
      }
    });

    // Load XP Settings
    async function loadXPSettings() {
      try {
        // Load XP actions
        const actionsResponse = await fetch('/api/viewer-xp/actions');
        const actions = await actionsResponse.json();
        
        const tbody = document.getElementById('actionsTable');
        if (actions && actions.length > 0) {
          tbody.innerHTML = actions.map(action => {
            const actionName = action.action_type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            return `
              <tr>
                <td><strong>${actionName}</strong></td>
                <td>
                  <input type="number" class="form-control" id="xp_${action.action_type}" 
                         value="${action.xp_amount}" min="0" style="width: 100px;">
                </td>
                <td>
                  <input type="number" class="form-control" id="cooldown_${action.action_type}" 
                         value="${action.cooldown_seconds}" min="0" style="width: 120px;">
                </td>
                <td>
                  <input type="checkbox" class="form-check-input" id="enabled_${action.action_type}" 
                         ${action.enabled ? 'checked' : ''}>
                </td>
                <td>
                  <button class="btn btn-sm btn-primary" data-action="updateAction" data-arg="${action.action_type}">
                    üíæ Save
                  </button>
                </td>
              </tr>
            `;
          }).join('');
        } else {
          tbody.innerHTML = `
            <tr>
              <td colspan="5">
                <div class="empty-state">
                  <div class="empty-state-icon">‚öôÔ∏è</div>
                  <div class="empty-state-text">No actions configured</div>
                </div>
              </td>
            </tr>
          `;
        }

        // Load general settings
        const settingsResponse = await fetch('/api/viewer-xp/settings');
        const settings = await settingsResponse.json();
        
        if (settings) {
          document.getElementById('enableDailyBonus').checked = settings.enableDailyBonus !== false;
          document.getElementById('enableStreaks').checked = settings.enableStreaks !== false;
          document.getElementById('enableWatchTime').checked = settings.enableWatchTime !== false;
          document.getElementById('watchTimeInterval').value = settings.watchTimeInterval || 5;
          document.getElementById('announceLevelUps').checked = settings.announceLevel !== false;
        }
      } catch (error) {
        console.error('Error loading XP settings:', error);
        showToast('Failed to load XP settings', 'danger');
      }
    }

    // Update individual action
    async function updateAction(actionType) {
      try {
        const xpAmount = parseInt(document.getElementById(`xp_${actionType}`).value);
        const cooldown = parseInt(document.getElementById(`cooldown_${actionType}`).value);
        const enabled = document.getElementById(`enabled_${actionType}`).checked;

        // Validate parsed numbers
        if (isNaN(xpAmount) || xpAmount < 0) {
          showToast('Invalid XP amount - must be a positive number', 'danger');
          return;
        }
        
        if (isNaN(cooldown) || cooldown < 0) {
          showToast('Invalid cooldown - must be a positive number', 'danger');
          return;
        }

        const response = await fetch(`/api/viewer-xp/actions/${actionType}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            xp_amount: xpAmount,
            cooldown_seconds: cooldown,
            enabled: enabled
          })
        });

        const result = await response.json();
        
        if (response.ok && result.success) {
          showToast('Action updated successfully!', 'success');
        } else {
          showToast('Failed to update action', 'danger');
        }
      } catch (error) {
        console.error('Error updating action:', error);
        showToast('Failed to update action', 'danger');
      }
    }

    // Load Level Configuration
    async function loadLevelConfig() {
      try {
        const response = await fetch('/api/viewer-xp/level-config');
        const configs = await response.json();
        
        // For now, show a message that it's functional but basic
        const page = document.getElementById('page-level-config');
        const description = page.querySelector('.page-description');
        
        if (configs && configs.length > 0) {
          description.textContent = 'Level configuration is loaded. Advanced editing coming soon.';
          
          // Add a basic preview table
          let configHtml = `
            <div class="card">
              <div class="card-header">
                <span><span class="card-header-icon">üìä</span>Current Level Configuration</span>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="modern-table">
                    <thead>
                      <tr>
                        <th>Level</th>
                        <th>XP Required</th>
                        <th>Title</th>
                        <th>Color</th>
                      </tr>
                    </thead>
                    <tbody>
          `;
          
          configs.slice(0, 20).forEach(config => {
            configHtml += `
              <tr>
                <td><strong>${config.level}</strong></td>
                <td>${config.xp_required.toLocaleString()} XP</td>
                <td>${config.title || 'N/A'}</td>
                <td><span style="color: ${config.name_color || '#FFFFFF'}">‚óè</span> ${config.name_color || 'Default'}</td>
              </tr>
            `;
          });
          
          configHtml += `
                    </tbody>
                  </table>
                </div>
                <p class="form-text" style="margin-top: 16px;">
                  Showing first 20 levels. Advanced level configuration editor coming in a future update.
                </p>
              </div>
            </div>
          `;
          
          // Find existing content and replace or append
          const existingContent = page.querySelector('.card');
          if (existingContent) {
            existingContent.remove();
          }
          page.insertAdjacentHTML('beforeend', configHtml);
        }
      } catch (error) {
        console.error('Error loading level config:', error);
        const page = document.getElementById('page-level-config');
        page.innerHTML = `
          <div class="page-header">
            <h1 class="page-title">üìà Level Configuration</h1>
            <p class="page-description">Customize level progression and rewards</p>
          </div>
          <div class="alert alert-warning">
            <span>‚ö†Ô∏è</span>
            <div>
              <strong>Loading Error:</strong> Could not load level configuration data.
            </div>
          </div>
        `;
      }
    }

    // XP Settings Functions
    function resetSettings() {
      if (confirm('Are you sure you want to reset all settings to defaults?')) {
        document.getElementById('enableDailyBonus').checked = true;
        document.getElementById('enableStreaks').checked = true;
        document.getElementById('enableWatchTime').checked = true;
        document.getElementById('watchTimeInterval').value = 5;
        document.getElementById('announceLevelUps').checked = true;
        alert('Settings reset to defaults. Click "Save Settings" to apply.');
      }
    }

    // Manual Award Functions
    function clearAwardForm() {
      document.getElementById('manualAwardForm').reset();
      document.getElementById('awardResult').innerHTML = '';
    }

    const awardInput = document.getElementById('awardUsername');
    const awardSuggestions = document.getElementById('viewerSuggestions');
    let awardSearchTimer = null;

    async function fetchAwardSuggestions(term) {
      if (!term || term.length < 2) {
        awardSuggestions.innerHTML = '';
        return;
      }
      try {
        const response = await fetch(`/api/viewer-xp/search?q=${encodeURIComponent(term)}&limit=8`);
        const results = await response.json();
        awardSuggestions.innerHTML = results.map((viewer) => `<option value="${viewer.username}">Lvl ${viewer.level}</option>`).join('');
      } catch (error) {
        console.error('Suggestion search failed', error);
      }
    }

    awardInput?.addEventListener('input', (e) => {
      const term = e.target.value;
      clearTimeout(awardSearchTimer);
      awardSearchTimer = setTimeout(() => fetchAwardSuggestions(term), 200);
    });

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `alert alert-${type}`;
      toast.style.position = 'fixed';
      toast.style.top = '20px';
      toast.style.right = '20px';
      toast.style.zIndex = '9999';
      toast.style.maxWidth = '400px';
      toast.style.boxShadow = 'var(--shadow-lg)';
      
      const icon = type === 'success' ? '‚úÖ' : type === 'danger' ? '‚ùå' : 'üí°';
      toast.innerHTML = `
        <span>${icon}</span>
        <div>${message}</div>
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.transition = 'opacity 0.3s, transform 0.3s';
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => toast.remove(), 300);
      }, 4000);
    }

    document.getElementById('manualAwardForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = document.getElementById('awardUsername').value;
      const amount = parseInt(document.getElementById('awardAmount').value);
      const reason = document.getElementById('awardReason').value;
      
      const resultDiv = document.getElementById('awardResult');
      resultDiv.innerHTML = '<div class="spinner"></div> Awarding XP...';
      
      try {
        const response = await fetch('/api/viewer-xp/award', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, amount, reason })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          resultDiv.innerHTML = `
            <div class="alert alert-success">
              <span>‚úÖ</span>
              <div>
                <strong>Success!</strong> Awarded ${amount} XP to ${username}.
                ${result.leveledUp ? ` They leveled up to Level ${result.newLevel}!` : ''}
              </div>
            </div>
          `;
          clearAwardForm();
          loadRecentAwards();
          showToast(`Successfully awarded ${amount} XP to ${username}!`);
        } else {
          throw new Error(result.error || 'Failed to award XP');
        }
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="alert alert-danger">
            <span>‚ùå</span>
            <div><strong>Error:</strong> ${error.message}</div>
          </div>
        `;
      }
    });

    // General Settings Form Handler
    document.getElementById('generalSettingsForm')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const watchTimeInterval = parseInt(document.getElementById('watchTimeInterval').value);
      
      // Validate watch time interval
      if (isNaN(watchTimeInterval) || watchTimeInterval < 1 || watchTimeInterval > 60) {
        showToast('Watch time interval must be between 1 and 60 minutes', 'danger');
        return;
      }
      
      const settings = {
        enableDailyBonus: document.getElementById('enableDailyBonus').checked,
        enableStreaks: document.getElementById('enableStreaks').checked,
        enableWatchTime: document.getElementById('enableWatchTime').checked,
        watchTimeInterval: watchTimeInterval,
        announceLevel: document.getElementById('announceLevelUps').checked
      };
      
      try {
        const response = await fetch('/api/viewer-xp/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          showToast('Settings saved successfully!', 'success');
        } else {
          throw new Error(result.error || 'Failed to save settings');
        }
      } catch (error) {
        showToast(`Error saving settings: ${error.message}`, 'danger');
      }
    });

    async function loadRecentAwards() {
      try {
        const response = await fetch('/api/viewer-xp/manual-awards?limit=10');
        const awards = await response.json();
        
        const tbody = document.getElementById('recentAwardsTable');
        
        if (!awards || awards.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="4">
                <div class="empty-state">
                  <div class="empty-state-icon">üìú</div>
                  <div class="empty-state-text">No manual awards yet</div>
                </div>
              </td>
            </tr>
          `;
          return;
        }
        
        tbody.innerHTML = awards.map(award => `
          <tr>
            <td>${new Date(award.timestamp).toLocaleString()}</td>
            <td><strong>${escapeHtml(award.username)}</strong></td>
            <td><span class="badge badge-success">+${award.amount} XP</span></td>
            <td>${escapeHtml(award.reason || '-')}</td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading recent awards:', error);
      }
    }

    // Import/Export Functions
    async function exportData() {
      const btn = document.getElementById('exportDataBtn');
      const status = document.getElementById('exportStatus');
      
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Exporting...';
      status.innerHTML = '';
      
      try {
        const response = await fetch('/api/viewer-xp/export');
        const data = await response.json();
        
        // Create download
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `viewer-xp-export-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
        
        const viewerCount = Array.isArray(data.profiles) ? data.profiles.length : 0;
        status.innerHTML = `
          <div class="alert alert-success">
            <span>‚úÖ</span>
            <div><strong>Success!</strong> Export file downloaded. Exported ${viewerCount} viewers.</div>
          </div>
        `;
      } catch (error) {
        status.innerHTML = `
          <div class="alert alert-danger">
            <span>‚ùå</span>
            <div><strong>Error:</strong> ${error.message}</div>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üì• Download Export File';
      }
    }

    async function importData() {
      const fileInput = document.getElementById('importFile');
      const btn = document.getElementById('importDataBtn');
      const status = document.getElementById('importStatus');
      
      if (!fileInput.files || !fileInput.files[0]) {
        status.innerHTML = `
          <div class="alert alert-warning">
            <span>‚ö†Ô∏è</span>
            <div>Please select a file to import.</div>
          </div>
        `;
        return;
      }
      
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner"></span> Importing...';
      status.innerHTML = '';
      
      try {
        const file = fileInput.files[0];
        const text = await file.text();
        const data = JSON.parse(text);
        
        const response = await fetch('/api/viewer-xp/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          status.innerHTML = `
            <div class="alert alert-success">
              <span>‚úÖ</span>
              <div>
                <strong>Success!</strong> Imported ${result.imported} viewers.
                ${result.updated ? ` Updated ${result.updated} existing profiles.` : ''}
              </div>
            </div>
          `;
          fileInput.value = '';
          refreshData();
        } else {
          throw new Error(result.error || 'Import failed');
        }
      } catch (error) {
        status.innerHTML = `
          <div class="alert alert-danger">
            <span>‚ùå</span>
            <div><strong>Error:</strong> ${error.message}</div>
          </div>
        `;
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üì§ Import Data';
      }
    }

    async function loadViewerHistory() {
      const username = document.getElementById('historyUsername').value.trim();
      const container = document.getElementById('historyContainer');
      const tbody = document.getElementById('historyTable');
      const viewerNameEl = document.getElementById('historyViewerName');
      
      if (!username) {
        // Show inline error message instead of alert
        tbody.innerHTML = `
          <tr>
            <td colspan="4">
              <div class="alert alert-warning">
                <span>‚ö†Ô∏è</span>
                <div>Please enter a username to search</div>
              </div>
            </td>
          </tr>
        `;
        container.style.display = 'block';
        return;
      }
      
      try {
        const response = await fetch(`/api/viewer-xp/history/${encodeURIComponent(username)}`);
        const history = await response.json();
        
        if (!history || history.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="4">
                <div class="empty-state">
                  <div class="empty-state-icon">üìä</div>
                  <div class="empty-state-text">No history found</div>
                  <div class="empty-state-description">No XP transactions for this viewer</div>
                </div>
              </td>
            </tr>
          `;
        } else {
          tbody.innerHTML = history.map(item => {
            // Parse details if JSON string
            let detailsHtml = '-';
            if (item.details) {
              try {
                const details = typeof item.details === 'string' ? JSON.parse(item.details) : item.details;
                detailsHtml = Object.entries(details)
                  .map(([key, value]) => `${key}: ${escapeHtml(String(value))}`)
                  .join(', ');
              } catch (e) {
                console.warn('Failed to parse transaction details:', e, item.details);
                detailsHtml = escapeHtml(String(item.details));
              }
            }
            
            return `
              <tr>
                <td>${new Date(item.timestamp).toLocaleString()}</td>
                <td><span class="badge badge-primary">${escapeHtml(item.action_type)}</span></td>
                <td><strong>+${item.amount} XP</strong></td>
                <td style="font-size: 0.85rem; color: var(--color-text-muted);">${detailsHtml}</td>
              </tr>
            `;
          }).join('');
        }
        
        viewerNameEl.textContent = username;
        container.style.display = 'block';
      } catch (error) {
        console.error('Error loading history:', error);
        tbody.innerHTML = `
          <tr>
            <td colspan="4">
              <div class="alert alert-danger">
                <span>‚ùå</span>
                <div><strong>Error:</strong> Failed to load viewer history. ${error.message}</div>
              </div>
            </td>
          </tr>
        `;
        container.style.display = 'block';
      }
    }

    // ========== OVERLAY PREVIEW FUNCTIONS ==========
    
    // Test data constants
    const TEST_LEVEL = 5;
    const TEST_TOTAL_XP = 2500;  // Total XP earned across all levels
    const TEST_XP_FOR_NEXT_LEVEL = 500;  // XP required for next level
    const TEST_XP_PROGRESS = 250;  // Current progress in this level (0-500)
    
    // Helper function to calculate XP progress for test data
    function calculateTestXPProgress() {
      const xpProgressPercent = (TEST_XP_PROGRESS / TEST_XP_FOR_NEXT_LEVEL) * 100;
      return {
        xp: TEST_TOTAL_XP,  // Total XP earned
        xp_progress: TEST_XP_PROGRESS,  // Progress in current level
        xp_for_next_level: TEST_XP_FOR_NEXT_LEVEL,  // XP needed for next level
        xp_progress_percent: xpProgressPercent  // Percentage (50%)
      };
    }
    
    function loadOverlayPreview() {
      const select = document.getElementById('overlaySelect');
      const overlayType = select.value;
      const previewCard = document.getElementById('previewCard');
      const testControls = document.getElementById('testControls');
      const overlayURL = document.getElementById('overlayURL');
      const overlayURLInput = document.getElementById('overlayURLInput');
      
      if (!overlayType) {
        previewCard.style.display = 'none';
        testControls.style.display = 'none';
        overlayURL.style.display = 'none';
        return;
      }
      
      const baseURL = window.location.origin;
      const url = `${baseURL}/overlay/viewer-xp/${overlayType}`;
      
      overlayURLInput.value = url;
      overlayURL.style.display = 'block';
      previewCard.style.display = 'block';
      testControls.style.display = 'block';
      
      document.getElementById('previewFrame').src = url;
      updatePreviewScale();
    }
    
    function updatePreviewScale() {
      const scaleInput = document.getElementById('previewScale').value;
      let scale = parseFloat(scaleInput);
      
      // Validate scale value and apply default if invalid
      if (isNaN(scale) || scale <= 0 || scale > 2) {
        console.warn('Invalid preview scale value:', scaleInput, '- using default 1.0');
        scale = 1.0;
      }
      
      const container = document.getElementById('previewContainer');
      
      // Apply scale transform
      container.style.transform = `scale(${scale})`;
      
      // Adjust container dimensions to prevent overflow
      // When scaled down, the container takes less visual space
      const frameHeight = 600;
      container.style.height = `${frameHeight}px`;
      
      // Adjust parent to fit scaled content
      const parentHeight = frameHeight * scale;
      container.parentElement.style.minHeight = `${parentHeight + 40}px`;
    }
    
    function refreshPreview() {
      const frame = document.getElementById('previewFrame');
      if (frame.src) {
        frame.src = frame.src; // Reload iframe
      }
    }
    
    function copyOverlayURL() {
      const input = document.getElementById('overlayURLInput');
      copyToClipboard(input.value);
    }
    
    function copyToClipboard(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          showToast('‚úÖ URL copied to clipboard!');
        }).catch(err => {
          console.error('Failed to copy:', err);
          fallbackCopyToClipboard(text);
        });
      } else {
        fallbackCopyToClipboard(text);
      }
    }
    
    function fallbackCopyToClipboard(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-999999px';
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      
      try {
        const successful = document.execCommand('copy');
        if (successful) {
          showToast('‚úÖ URL copied to clipboard!');
        } else {
          showToast('‚ùå Failed to copy URL - please copy manually');
        }
      } catch (err) {
        console.error('Fallback copy failed:', err);
        showToast('‚ùå Failed to copy URL - please copy manually');
      }
      
      document.body.removeChild(textArea);
    }
    
    function testLevelUp() {
      const username = document.getElementById('testUsername').value || 'TestUser';
      const testData = {
        username,
        oldLevel: TEST_LEVEL,
        newLevel: TEST_LEVEL + 1,
        rewards: {
          title: 'Rising Star',
          badge: '‚≠ê',
          announcement_message: `Congratulations ${username}! You've reached Level ${TEST_LEVEL + 1}!`
        }
      };
      
      console.log('üß™ Testing Level Up:', testData);
      socket.emit('viewer-xp:level-up', testData);
      showToast('‚úÖ Level Up test event sent!', 'success');
    }
    
    function testXPGain() {
      const username = document.getElementById('testUsername').value || 'TestUser';
      const xpData = calculateTestXPProgress();
      
      const testData = {
        username,
        amount: 50,
        actionType: 'chat_message',
        profile: {
          username,
          level: TEST_LEVEL,
          xp: xpData.xp,
          total_xp_earned: TEST_TOTAL_XP,
          xp_progress: xpData.xp_progress,
          xp_for_next_level: xpData.xp_for_next_level,
          xp_progress_percent: xpData.xp_progress_percent,
          name_color: '#FFD700',
          title: 'Rising Star'
        }
      };
      
      console.log('üß™ Testing XP Gain:', testData);
      socket.emit('viewer-xp:update', testData);
      showToast('‚úÖ XP Gain test event sent!', 'success');
    }
    
    function refreshLeaderboardPreview() {
      // Request actual leaderboard data from the server
      console.log('üß™ Requesting leaderboard data...');
      socket.emit('viewer-xp:get-leaderboard', {
        limit: 10,
        days: null
      });
      showToast('‚úÖ Leaderboard refresh requested!', 'success');
    }
    
    function testUserProfile() {
      const username = document.getElementById('testUsername').value || 'TestUser';
      const xpData = calculateTestXPProgress();
      
      const testData = {
        username,
        level: TEST_LEVEL,
        xp: xpData.xp,
        total_xp_earned: TEST_TOTAL_XP,
        xp_progress: xpData.xp_progress,
        xp_for_next_level: xpData.xp_for_next_level,
        xp_progress_percent: xpData.xp_progress_percent,
        rank: 42,
        title: 'Rising Star',
        name_color: '#FFD700',
        badges: ['üéÆ', '‚≠ê', 'üèÜ'],
        streak_days: 7,
        watch_time_minutes: 180,
        last_seen: new Date().toISOString()
      };
      
      console.log('üß™ Testing User Profile:', testData);
      socket.emit('viewer-xp:show-user-profile', testData);
      showToast('‚úÖ User Profile test event sent!', 'success');
    }

    // ========== LEVEL CONFIGURATION FUNCTIONS ==========
    
    function updateLevelTypeSettings() {
      const type = document.querySelector('input[name="levelType"]:checked').value;
      const linearSettings = document.getElementById('linearSettings');
      const levelGeneratorCard = document.getElementById('levelGeneratorCard');
      
      linearSettings.style.display = type === 'linear' ? 'block' : 'none';
      levelGeneratorCard.style.display = type === 'custom' ? 'block' : 'none';
    }
    
    async function saveLevelTypeSettings() {
      try {
        const type = document.querySelector('input[name="levelType"]:checked').value;
        const settings = { levelType: type };
        
        if (type === 'linear') {
          settings.xpPerLevel = document.getElementById('xpPerLevel').value;
        }
        
        const response = await fetch('/api/viewer-xp/settings', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(settings)
        });
        
        if (response.ok) {
          showToast('‚úÖ Progression settings saved!');
        } else {
          throw new Error('Failed to save settings');
        }
      } catch (error) {
        console.error('Error saving level type:', error);
        showToast('‚ùå Failed to save settings');
      }
    }
    
    function previewLevelProgression() {
      const count = parseInt(document.getElementById('genLevelCount').value);
      const startXP = parseInt(document.getElementById('genStartXP').value);
      const growthRate = document.getElementById('genGrowthRate').value;
      
      const rates = {
        slow: 1.1,
        medium: 1.2,
        fast: 1.5,
        extreme: 2.0
      };
      const rate = rates[growthRate];
      
      const tbody = document.getElementById('progressionPreviewTable');
      tbody.innerHTML = '';
      
      let totalXP = 0;
      let xpForNext = startXP;

      let prevXPForNext = startXP;
      for (let i = 1; i <= count; i++) {
        if (i > 1) {
          totalXP += xpForNext;
          xpForNext = Math.floor(xpForNext * rate);
        }
        
        const growth = i === 1 ? '-' : `${((xpForNext / prevXPForNext - 1) * 100).toFixed(1)}%`;
        tbody.innerHTML += `
          <tr>
            <td><strong>Level ${i}</strong></td>
            <td>${totalXP.toLocaleString()} XP</td>
            <td>+${xpForNext.toLocaleString()} XP</td>
            <td>${growth}</td>
          </tr>
        `;
        
        prevXPForNext = xpForNext;
      }
      
      document.getElementById('levelProgressionPreview').style.display = 'block';
    }
    
    async function generateLevelConfigs() {
      const count = parseInt(document.getElementById('genLevelCount').value);
      const startXP = parseInt(document.getElementById('genStartXP').value);
      const growthRate = document.getElementById('genGrowthRate').value;
      
      try {
        const response = await fetch('/api/viewer-xp/level-config/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: growthRate,
            settings: {
              count,
              startXP
            }
          })
        });
        
        if (response.ok) {
          const configs = await response.json();
          showToast(`‚úÖ Generated ${configs.length} level configurations!`);
          previewLevelProgression();
        } else {
          throw new Error('Failed to generate configs');
        }
      } catch (error) {
        console.error('Error generating levels:', error);
        showToast('‚ùå Failed to generate level configurations');
      }
    }
    
    let currentLevelRewards = [];

    function renderLevelRewards(rewards) {
      const tbody = document.getElementById('levelRewardsTable');
      if (!rewards || rewards.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6">
              <div class="empty-state">
                <div class="empty-state-icon">üéÅ</div>
                <div class="empty-state-text">No rewards configured yet</div>
                <div class="empty-state-description">Add milestone rewards for reaching specific levels</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = rewards.map((reward) => `
        <tr data-level="${reward.level}">
          <td><input type="number" class="form-control" value="${reward.level}" min="1" data-field="level"></td>
          <td><input type="text" class="form-control" value="${reward.title || ''}" placeholder="Title/Badge" data-field="title"></td>
          <td><input type="color" class="form-control" value="${reward.name_color || '#ffffff'}" data-field="name_color"></td>
          <td><input type="text" class="form-control" value="${reward.announcement_message || ''}" placeholder="Custom emote or message" data-field="announcement_message"></td>
          <td><input type="text" class="form-control" value="${reward.special_effects?.animation || ''}" placeholder="Animation key" data-field="animation"></td>
          <td>
            <button class="btn btn-sm btn-success" data-action="saveLevelReward" data-arg="${reward.level}">üíæ Save</button>
            <button class="btn btn-sm btn-danger" data-action="deleteLevelReward" data-arg="${reward.level}">üóëÔ∏è</button>
          </td>
        </tr>
      `).join('');
    }

    function addLevelReward() {
      const nextLevel = currentLevelRewards.length > 0
        ? Math.max(...currentLevelRewards.map(r => Number(r.level))) + 1
        : 1;
      currentLevelRewards.push({ level: nextLevel, title: '', name_color: '#ffffff', announcement_message: '', special_effects: { animation: '' } });
      renderLevelRewards(currentLevelRewards);
    }
    
    async function loadLevelRewards() {
      try {
        const response = await fetch('/api/viewer-xp/level-rewards');
        currentLevelRewards = await response.json();
        renderLevelRewards(currentLevelRewards);
        showToast('‚úÖ Level rewards loaded', 'success');
      } catch (error) {
        console.error('Error loading level rewards:', error);
        showToast('‚ùå Failed to load level rewards', 'danger');
      }
    }

    async function saveLevelReward(level) {
      const row = document.querySelector(`#levelRewardsTable tr[data-level="${level}"]`);
      if (!row) return;

      const getValue = (field) => row.querySelector(`[data-field="${field}"]`)?.value;
      const payload = {
        level: parseInt(getValue('level')),
        title: getValue('title'),
        name_color: getValue('name_color'),
        announcement_message: getValue('announcement_message'),
        animation: getValue('animation')
      };

      try {
        const response = await fetch('/api/viewer-xp/level-rewards', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const result = await response.json();
        if (response.ok && result.success) {
          showToast('Level reward saved', 'success');
          loadLevelRewards();
        } else {
          throw new Error(result.error || 'Failed to save');
        }
      } catch (error) {
        console.error('Error saving reward:', error);
        showToast('‚ùå Failed to save reward', 'danger');
      }
    }

    async function deleteLevelReward(level) {
      if (!confirm('Delete this level reward?')) return;
      try {
        const response = await fetch(`/api/viewer-xp/level-rewards/${level}`, { method: 'DELETE' });
        const result = await response.json();
        if (response.ok && result.success) {
          currentLevelRewards = currentLevelRewards.filter(r => Number(r.level) !== Number(level));
          renderLevelRewards(currentLevelRewards);
          showToast('Reward deleted', 'success');
        } else {
          throw new Error(result.error || 'Failed to delete');
        }
      } catch (error) {
        console.error('Error deleting reward:', error);
        showToast('‚ùå Failed to delete reward', 'danger');
      }
    }

    // ========== SPIN WHEEL FUNCTIONS ==========

    let spinConfig = null;
    let wheelPreviewCanvas = null;
    let wheelPreviewCtx = null;

    // Load spin configuration
    async function loadSpinConfig() {
      try {
        const response = await fetch('/api/viewer-xp/spin/config');
        const result = await response.json();
        if (result.success) {
          spinConfig = result.config;
          document.getElementById('spinEnabled').checked = spinConfig.enabled === 1;
          document.getElementById('spinMinBet').value = spinConfig.min_bet;
          document.getElementById('spinMaxBet').value = spinConfig.max_bet;
          document.getElementById('spinDefaultBet').value = spinConfig.default_bet || 1000;
          document.getElementById('spinNumFields').value = spinConfig.num_fields;
          document.getElementById('spinFieldValues').value = spinConfig.field_values.join('\n');
          
          // Initialize wheel preview
          initWheelPreview();
          drawWheelPreview();
          
          // Load spin stats
          loadSpinStats();
          loadSpinHistory();
        }
      } catch (error) {
        console.error('Error loading spin config:', error);
        showToast('Failed to load spin configuration', 'error');
      }
    }

    // Initialize wheel preview canvas
    function initWheelPreview() {
      wheelPreviewCanvas = document.getElementById('wheelPreviewCanvas');
      if (wheelPreviewCanvas) {
        wheelPreviewCtx = wheelPreviewCanvas.getContext('2d');
      }
    }

    // Draw wheel preview
    function drawWheelPreview() {
      if (!wheelPreviewCtx || !wheelPreviewCanvas) return;
      
      const fieldValuesText = document.getElementById('spinFieldValues').value;
      const fieldValues = fieldValuesText.split('\n').map(v => parseInt(v.trim())).filter(v => !isNaN(v));
      
      if (fieldValues.length === 0) return;
      
      const centerX = wheelPreviewCanvas.width / 2;
      const centerY = wheelPreviewCanvas.height / 2;
      const radius = 140;
      const anglePerSegment = (2 * Math.PI) / fieldValues.length;
      
      // Clear canvas
      wheelPreviewCtx.clearRect(0, 0, wheelPreviewCanvas.width, wheelPreviewCanvas.height);
      
      // Draw segments
      fieldValues.forEach((value, index) => {
        const startAngle = anglePerSegment * index - Math.PI / 2;
        const endAngle = startAngle + anglePerSegment;
        
        // Draw segment
        wheelPreviewCtx.beginPath();
        wheelPreviewCtx.moveTo(centerX, centerY);
        wheelPreviewCtx.arc(centerX, centerY, radius, startAngle, endAngle);
        wheelPreviewCtx.closePath();
        
        // Color: green for positive, red for negative
        if (value >= 0) {
          wheelPreviewCtx.fillStyle = `hsl(120, ${50 + (index % 2) * 20}%, ${40 + (index % 2) * 10}%)`;
        } else {
          wheelPreviewCtx.fillStyle = `hsl(0, ${50 + (index % 2) * 20}%, ${40 + (index % 2) * 10}%)`;
        }
        wheelPreviewCtx.fill();
        
        // Draw border
        wheelPreviewCtx.strokeStyle = '#fff';
        wheelPreviewCtx.lineWidth = 2;
        wheelPreviewCtx.stroke();
        
        // Draw text
        const textAngle = startAngle + anglePerSegment / 2;
        const textRadius = radius * 0.7;
        const textX = centerX + Math.cos(textAngle) * textRadius;
        const textY = centerY + Math.sin(textAngle) * textRadius;
        
        wheelPreviewCtx.save();
        wheelPreviewCtx.translate(textX, textY);
        wheelPreviewCtx.rotate(textAngle + Math.PI / 2);
        wheelPreviewCtx.fillStyle = '#fff';
        wheelPreviewCtx.font = 'bold 16px Arial';
        wheelPreviewCtx.textAlign = 'center';
        wheelPreviewCtx.textBaseline = 'middle';
        wheelPreviewCtx.fillText(formatNumber(value), 0, 0);
        wheelPreviewCtx.restore();
      });
      
      // Draw center circle
      wheelPreviewCtx.beginPath();
      wheelPreviewCtx.arc(centerX, centerY, 30, 0, 2 * Math.PI);
      wheelPreviewCtx.fillStyle = '#FFD700';
      wheelPreviewCtx.fill();
      wheelPreviewCtx.strokeStyle = '#fff';
      wheelPreviewCtx.lineWidth = 3;
      wheelPreviewCtx.stroke();
      
      // Draw center emoji
      wheelPreviewCtx.font = '24px Arial';
      wheelPreviewCtx.fillStyle = '#000';
      wheelPreviewCtx.textAlign = 'center';
      wheelPreviewCtx.textBaseline = 'middle';
      wheelPreviewCtx.fillText('üé∞', centerX, centerY);
    }

    // Save spin configuration
    async function saveSpinConfig() {
      try {
        const fieldValuesText = document.getElementById('spinFieldValues').value;
        const fieldValues = fieldValuesText.split('\n').map(v => parseInt(v.trim())).filter(v => !isNaN(v));
        
        if (fieldValues.length === 0) {
          showToast('Please enter at least one field value', 'error');
          return;
        }
        
        const config = {
          enabled: document.getElementById('spinEnabled').checked ? 1 : 0,
          min_bet: parseInt(document.getElementById('spinMinBet').value),
          max_bet: parseInt(document.getElementById('spinMaxBet').value),
          default_bet: parseInt(document.getElementById('spinDefaultBet').value) || 1000,
          num_fields: fieldValues.length,
          field_values: fieldValues
        };
        
        const response = await fetch('/api/viewer-xp/spin/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(config)
        });
        
        const result = await response.json();
        if (result.success) {
          showToast('Spin configuration saved successfully', 'success');
          loadSpinConfig();
        } else {
          throw new Error(result.error || 'Failed to save');
        }
      } catch (error) {
        console.error('Error saving spin config:', error);
        showToast('Failed to save spin configuration', 'error');
      }
    }

    // Load spin history
    async function loadSpinHistory() {
      try {
        const response = await fetch('/api/viewer-xp/spin/history?limit=20');
        const result = await response.json();
        if (result.success && result.history.length > 0) {
          renderSpinHistory(result.history);
        }
      } catch (error) {
        console.error('Error loading spin history:', error);
      }
    }

    // Render spin history
    function renderSpinHistory(history) {
      const container = document.getElementById('spinHistoryContainer');
      if (!container) return;
      
      container.innerHTML = `
        <div style="overflow-x: auto;">
          <table class="data-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Bet</th>
                <th>Field</th>
                <th>Result</th>
                <th>XP Change</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody>
              ${history.map(spin => {
                const isWin = spin.xp_change > 0;
                const changeColor = isWin ? '#00ff00' : '#ff4444';
                const fieldSign = spin.field_value >= 0 ? '+' : '';
                const changeSign = spin.xp_change >= 0 ? '+' : '';
                
                return `
                  <tr>
                    <td><strong>${spin.username}</strong></td>
                    <td>${formatNumber(spin.bet_amount)}</td>
                    <td>${fieldSign}${formatNumber(spin.field_value)}</td>
                    <td style="color: ${changeColor}; font-weight: bold;">${isWin ? 'üéâ WIN' : 'üò¢ LOSS'}</td>
                    <td style="color: ${changeColor}; font-weight: bold;">${changeSign}${formatNumber(spin.xp_change)}</td>
                    <td>${new Date(spin.timestamp).toLocaleString()}</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // Load spin statistics
    async function loadSpinStats() {
      try {
        const response = await fetch('/api/viewer-xp/spin/stats');
        const result = await response.json();
        if (result.success && result.stats) {
          const stats = result.stats;
          document.getElementById('statTotalSpins').textContent = stats.total_spins || 0;
          document.getElementById('statWins').textContent = stats.wins || 0;
          document.getElementById('statLosses').textContent = stats.losses || 0;
          
          const netChange = stats.net_xp_change || 0;
          const netEl = document.getElementById('statNetChange');
          netEl.textContent = formatNumber(netChange);
          netEl.style.color = netChange >= 0 ? '#00ff00' : '#ff4444';
          
          document.getElementById('statBiggestWin').textContent = formatNumber(stats.biggest_win || 0);
          document.getElementById('statBiggestLoss').textContent = formatNumber(stats.biggest_loss || 0);
        }
      } catch (error) {
        console.error('Error loading spin stats:', error);
      }
    }

    // Listen for field values changes to update preview
    document.addEventListener('input', function(event) {
      if (event.target.id === 'spinFieldValues') {
        drawWheelPreview();
      }
    });

    // Handle spin config form submission
    document.addEventListener('submit', function(event) {
      if (event.target.id === 'spinConfigForm') {
        event.preventDefault();
        saveSpinConfig();
      }
    });

    // Load spin config when spin settings page is shown
    document.addEventListener('click', function(event) {
      const navItem = event.target.closest('.nav-item[data-page="spin-settings"]');
      if (navItem) {
        setTimeout(() => {
          loadSpinConfig();
        }, 100);
      }
    });

    // ========== UTILITY FUNCTIONS ==========
    
    // Add CSS animations for toast notifications
    // Check prevents duplicate style injection if this code runs multiple times
    if (!document.getElementById('toastAnimations')) {
      const style = document.createElement('style');
      style.id = 'toastAnimations';
      style.textContent = `
        @keyframes slideIn {
          from {
            transform: translateX(400px);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        @keyframes slideOut {
          from {
            transform: translateX(0);
            opacity: 1;
          }
          to {
            transform: translateX(400px);
            opacity: 0;
          }
        }
      `;
      document.head.appendChild(style);
    }

    // Event delegation for all buttons with data-action attribute
    // This replaces inline onclick handlers to comply with CSP
    document.addEventListener('click', function(event) {
      const button = event.target.closest('[data-action]');
      if (!button) return;

      const action = button.getAttribute('data-action');
      const arg = button.getAttribute('data-arg');
      const page = button.getAttribute('data-page');
      const target = button.getAttribute('data-target');
      const overlayType = button.getAttribute('data-overlay-type');
      const actionType = button.getAttribute('data-action-type');
      const username = button.getAttribute('data-username');
      const sourceId = button.getAttribute('data-source-id');

      // Map actions to function calls
      switch(action) {
        case 'navigateTo':
          navigateTo(page || arg);
          break;
        case 'refreshData':
          refreshData();
          break;
        case 'refreshLeaderboard':
          refreshLeaderboard();
          break;
        case 'copyToClipboard':
          if (target) {
            copyToClipboard(target);
          } else if (sourceId) {
            const sourceElement = document.getElementById(sourceId);
            if (sourceElement) {
              copyToClipboard(sourceElement.value);
            }
          } else if (arg) {
            // arg is an element ID, get the element and copy its text content
            const argElement = document.getElementById(arg);
            if (argElement) {
              copyToClipboard(argElement.textContent.trim());
            } else {
              // Fallback: if element not found, copy arg as-is
              copyToClipboard(arg);
            }
          }
          break;
        case 'updateOverlayUrl':
          updateOverlayUrl(overlayType || arg);
          break;
        case 'testOverlay':
          testOverlay(overlayType || arg);
          break;
        case 'refreshPreview':
          refreshPreview();
          break;
        case 'copyOverlayURL':
          copyOverlayURL();
          break;
        case 'testLevelUp':
          testLevelUp();
          break;
        case 'testXPGain':
          testXPGain();
          break;
        case 'refreshLeaderboardPreview':
          refreshLeaderboardPreview();
          break;
        case 'testUserProfile':
          testUserProfile();
          break;
        case 'resetSettings':
          resetSettings();
          break;
        case 'saveLevelTypeSettings':
          saveLevelTypeSettings();
          break;
        case 'generateLevelConfigs':
          generateLevelConfigs();
          break;
        case 'previewLevelProgression':
          previewLevelProgression();
          break;
        case 'addLevelReward':
          addLevelReward();
          break;
        case 'loadLevelRewards':
          loadLevelRewards();
          break;
        case 'saveLevelReward':
          saveLevelReward(arg);
          break;
        case 'deleteLevelReward':
          deleteLevelReward(arg);
          break;
        case 'clearAwardForm':
          clearAwardForm();
          break;
        case 'exportData':
          exportData();
          break;
        case 'importData':
          importData();
          break;
        case 'loadViewerHistory':
          loadViewerHistory();
          break;
        case 'viewUserDetails':
          viewUserDetails(username || arg);
          break;
        case 'updateAction':
          updateAction(actionType || arg);
          break;
        default:
          console.warn('Unknown action:', action);
      }
    });

    // Refresh spin history button
    document.getElementById('refreshSpinHistoryBtn')?.addEventListener('click', function() {
      loadSpinHistory();
      loadSpinStats();
      showToast('Spin history refreshed', 'success');
    });

    // ========================================
    // NEW: v2.1.0 Page Functions
    // ========================================

    // Overview Page
    async function loadOverviewPage() {
      try {
        // Load stats
        const statsResp = await fetch('/api/viewer-xp/stats');
        const stats = await statsResp.json();
        
        document.getElementById('overview-total-viewers').textContent = (stats.totalViewers || 0).toLocaleString();
        document.getElementById('overview-total-xp').textContent = formatNumber(stats.totalXPEarned || 0);
        document.getElementById('overview-avg-level').textContent = (stats.avgLevel || 0).toFixed(1);

        // Load today's events count
        const today = Date.now() - (24 * 60 * 60 * 1000);
        const logsResp = await fetch(`/api/viewer-xp/logs?start_time=${today}&limit=1`);
        const logsData = await logsResp.json();
        document.getElementById('overview-total-events').textContent = (logsData.pagination?.total || 0).toLocaleString();

        // Load leaderboard
        loadOverviewLeaderboard();
      } catch (error) {
        console.error('Error loading overview:', error);
      }
    }

    async function loadOverviewLeaderboard(days = null) {
      try {
        const url = days ? `/api/viewer-xp/leaderboard?limit=10&days=${days}` : '/api/viewer-xp/leaderboard?limit=10';
        const response = await fetch(url);
        const leaderboard = await response.json();
        
        const tbody = document.getElementById('overview-leaderboard-body');
        if (!leaderboard || leaderboard.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No viewers yet</td></tr>';
          return;
        }

        tbody.innerHTML = leaderboard.map((viewer, index) => {
          const rank = index + 1;
          const rankIcon = rank === 1 ? 'üëë' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : rank;
          return `
            <tr>
              <td><strong>${rankIcon} ${rank}</strong></td>
              <td>${escapeHtml(viewer.username)}</td>
              <td><span class="badge badge-level">Lvl ${viewer.level}</span></td>
              <td>${formatNumber(viewer.xp || 0)} XP</td>
              <td>${viewer.streak_days || 0} days</td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="loadUserDetailByUsername('${escapeHtml(viewer.username)}')">
                  View
                </button>
              </td>
            </tr>
          `;
        }).join('');
      } catch (error) {
        console.error('Error loading overview leaderboard:', error);
      }
    }

    // Overview search
    let overviewSearchTimeout;
    document.getElementById('overview-search-input')?.addEventListener('input', function(e) {
      clearTimeout(overviewSearchTimeout);
      const query = e.target.value.trim();
      
      if (query.length < 2) {
        document.getElementById('overview-search-results').innerHTML = '';
        return;
      }

      overviewSearchTimeout = setTimeout(async () => {
        try {
          const response = await fetch(`/api/viewer-xp/search?q=${encodeURIComponent(query)}&limit=5`);
          const results = await response.json();
          
          const resultsHtml = results.map(user => `
            <div style="padding: 12px; border: 1px solid var(--color-border); border-radius: 8px; margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
              <div>
                <strong>${escapeHtml(user.username)}</strong>
                <span class="badge badge-level" style="margin-left: 8px;">Lvl ${user.level}</span>
                <div style="font-size: 0.875rem; color: var(--color-text-muted);">${formatNumber(user.xp || 0)} XP</div>
              </div>
              <button class="btn btn-sm btn-primary" onclick="loadUserDetailByUsername('${escapeHtml(user.username)}')">
                View
              </button>
            </div>
          `).join('');
          
          document.getElementById('overview-search-results').innerHTML = resultsHtml || '<p style="margin-top: 12px; color: var(--color-text-muted);">No users found</p>';
        } catch (error) {
          console.error('Error searching users:', error);
        }
      }, 300);
    });

    document.getElementById('overview-period-filter')?.addEventListener('change', function() {
      const days = this.value;
      loadOverviewLeaderboard(days || null);
    });

    // User Detail Page
    let currentUserDetail = null;

    function loadUserDetailByUsername(username) {
      navigateTo('user-detail');
      document.getElementById('user-detail-search').value = username;
      loadUserDetail(username);
    }

    document.getElementById('user-detail-search-btn')?.addEventListener('click', function() {
      const username = document.getElementById('user-detail-search').value.trim();
      if (username) {
        loadUserDetail(username);
      }
    });

    document.getElementById('user-detail-search')?.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        const username = this.value.trim();
        if (username) {
          loadUserDetail(username);
        }
      }
    });

    async function loadUserDetail(username) {
      try {
        currentUserDetail = username;
        
        // Load user summary
        const response = await fetch(`/api/viewer-xp/user/${encodeURIComponent(username)}/summary`);
        if (!response.ok) {
          alert('User not found');
          return;
        }
        
        const data = await response.json();
        
        // Show content
        document.getElementById('user-detail-content').style.display = 'block';
        
        // Update profile info
        document.getElementById('user-detail-username').textContent = username;
        document.getElementById('user-detail-level').textContent = data.profile.level;
        document.getElementById('user-detail-xp').textContent = formatNumber(data.profile.xp);
        document.getElementById('user-detail-xp-to-next').textContent = formatNumber(data.level_info.xp_to_next_level);
        document.getElementById('user-detail-streak').textContent = data.profile.streak_days || 0;
        
        // Update progress bar
        const progress = Math.min(Math.max(data.level_info.progress_percent || 0, 0), 100);
        document.getElementById('user-detail-progress-bar').style.width = progress + '%';
        document.getElementById('user-detail-progress-text').textContent = progress.toFixed(1) + '%';
        
        // Show opt-out status
        const optOutStatus = document.getElementById('user-detail-opt-out-status');
        if (data.opted_out) {
          optOutStatus.style.display = 'block';
        } else {
          optOutStatus.style.display = 'none';
        }
        
        // Load badges
        const badgesContainer = document.getElementById('user-detail-badges');
        if (data.profile.badges && data.profile.badges.length > 0) {
          badgesContainer.innerHTML = data.profile.badges.map(badge => 
            `<span class="badge badge-success" style="margin: 4px;">üèÜ ${escapeHtml(badge)}</span>`
          ).join('');
        } else {
          badgesContainer.innerHTML = '<p style="color: var(--color-text-muted);">No badges yet</p>';
        }
        
        // Load recent events
        const eventsBody = document.getElementById('user-detail-events-body');
        if (data.recent_events && data.recent_events.length > 0) {
          eventsBody.innerHTML = data.recent_events.map(event => `
            <tr>
              <td>${formatTimestamp(event.created_at)}</td>
              <td>${escapeHtml(event.event_type)}</td>
              <td><span class="badge badge-success">+${event.xp_awarded} XP</span></td>
              <td>${event.meta ? JSON.stringify(event.meta) : '-'}</td>
            </tr>
          `).join('');
        } else {
          eventsBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">No recent events</td></tr>';
        }
      } catch (error) {
        console.error('Error loading user detail:', error);
        alert('Error loading user details');
      }
    }

    document.getElementById('user-detail-opt-out-toggle')?.addEventListener('click', async function() {
      if (!currentUserDetail) return;
      
      try {
        // Get current status
        const statusResp = await fetch(`/api/viewer-xp/user/${encodeURIComponent(currentUserDetail)}/opt-out`);
        const statusData = await statusResp.json();
        const currentlyOptedOut = statusData.opted_out;
        
        // Toggle
        const response = await fetch(`/api/viewer-xp/user/${encodeURIComponent(currentUserDetail)}/opt-out`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ opt_out: !currentlyOptedOut })
        });
        
        if (response.ok) {
          alert(currentlyOptedOut ? 'User opted back in' : 'User opted out');
          loadUserDetail(currentUserDetail);
        }
      } catch (error) {
        console.error('Error toggling opt-out:', error);
        alert('Error updating opt-out status');
      }
    });

    // Configuration Page
    async function loadConfigPage() {
      try {
        const response = await fetch('/api/viewer-xp/config');
        const data = await response.json();
        const config = data.config || {};
        
        // XP Multipliers
        document.getElementById('config-global-multiplier').value = config.xp_multipliers?.global || 1.0;
        document.getElementById('config-gift-value-based').checked = config.xp_multipliers?.gift_value_based || false;
        document.getElementById('config-gift-quantity-based').checked = config.xp_multipliers?.gift_quantity_based || false;
        
        // Rate Limits
        document.getElementById('config-rate-limits-enabled').checked = config.rate_limits?.enabled || false;
        document.getElementById('config-max-xp-5min').value = config.rate_limits?.global_limits?.max_xp_per_5min || 10000;
        document.getElementById('config-max-xp-hour').value = config.rate_limits?.global_limits?.max_xp_per_hour || 50000;
        
        // Event Caps
        document.getElementById('config-cap-chat').value = config.event_caps?.chat_message || 10;
        document.getElementById('config-cap-like').value = config.event_caps?.like || 5;
        document.getElementById('config-cap-share').value = config.event_caps?.share || 50;
        document.getElementById('config-cap-gift').value = config.event_caps?.gift || 10000;
        document.getElementById('config-cap-follow').value = config.event_caps?.follow || 100;
        document.getElementById('config-cap-subscribe').value = config.event_caps?.subscribe || 200;
        
        // Streaks
        document.getElementById('config-streaks-enabled').checked = config.streaks?.enabled || false;
        document.getElementById('config-streak-multiplier').value = config.streaks?.bonus_multiplier || 1.1;
        document.getElementById('config-streak-max').value = config.streaks?.max_multiplier || 2.0;
      } catch (error) {
        console.error('Error loading config:', error);
      }
    }

    document.getElementById('config-save-btn')?.addEventListener('click', async function() {
      try {
        const status = document.getElementById('config-save-status');
        status.textContent = 'Saving...';
        status.style.color = 'var(--color-text-muted)';
        
        // Collect configuration
        const configs = [
          {
            key: 'xp_multipliers',
            value: {
              global: parseFloat(document.getElementById('config-global-multiplier').value),
              gift_value_based: document.getElementById('config-gift-value-based').checked,
              gift_quantity_based: document.getElementById('config-gift-quantity-based').checked
            }
          },
          {
            key: 'rate_limits',
            value: {
              enabled: document.getElementById('config-rate-limits-enabled').checked,
              global_limits: {
                max_xp_per_5min: parseInt(document.getElementById('config-max-xp-5min').value),
                max_xp_per_hour: parseInt(document.getElementById('config-max-xp-hour').value)
              }
            }
          },
          {
            key: 'event_caps',
            value: {
              chat_message: parseInt(document.getElementById('config-cap-chat').value),
              like: parseInt(document.getElementById('config-cap-like').value),
              share: parseInt(document.getElementById('config-cap-share').value),
              gift: parseInt(document.getElementById('config-cap-gift').value),
              follow: parseInt(document.getElementById('config-cap-follow').value),
              subscribe: parseInt(document.getElementById('config-cap-subscribe').value)
            }
          },
          {
            key: 'streaks',
            value: {
              enabled: document.getElementById('config-streaks-enabled').checked,
              bonus_multiplier: parseFloat(document.getElementById('config-streak-multiplier').value),
              max_multiplier: parseFloat(document.getElementById('config-streak-max').value)
            }
          }
        ];

        // Save each config
        for (const config of configs) {
          const response = await fetch('/api/viewer-xp/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(config)
          });
          
          if (!response.ok) {
            throw new Error(`Failed to save ${config.key}`);
          }
        }
        
        status.textContent = '‚úÖ Configuration saved successfully!';
        status.style.color = 'var(--color-accent-success)';
        
        setTimeout(() => {
          status.textContent = '';
        }, 3000);
      } catch (error) {
        console.error('Error saving config:', error);
        const status = document.getElementById('config-save-status');
        status.textContent = '‚ùå Error saving configuration';
        status.style.color = 'var(--color-accent-danger)';
      }
    });

    // Event Logs Page
    let logsCurrentPage = 0;
    let logsCurrentFilters = {};

    async function loadEventTypesForLogs() {
      try {
        const response = await fetch('/api/viewer-xp/event-types');
        const data = await response.json();
        const types = data.event_types || [];
        
        const select = document.getElementById('logs-filter-type');
        select.innerHTML = '<option value="">All Types</option>' + 
          types.map(type => `<option value="${escapeHtml(type)}">${escapeHtml(type)}</option>`).join('');
      } catch (error) {
        console.error('Error loading event types:', error);
      }
    }

    document.getElementById('logs-apply-filter-btn')?.addEventListener('click', function() {
      logsCurrentPage = 0;
      applyLogsFilter();
    });

    document.getElementById('logs-reset-filter-btn')?.addEventListener('click', function() {
      document.getElementById('logs-filter-username').value = '';
      document.getElementById('logs-filter-type').value = '';
      document.getElementById('logs-filter-period').value = '';
      document.getElementById('logs-limit').value = '50';
      logsCurrentPage = 0;
      logsCurrentFilters = {};
      document.getElementById('logs-table-body').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">Click "Apply Filters" to load events</td></tr>';
    });

    document.getElementById('logs-prev-btn')?.addEventListener('click', function() {
      if (logsCurrentPage > 0) {
        logsCurrentPage--;
        applyLogsFilter();
      }
    });

    document.getElementById('logs-next-btn')?.addEventListener('click', function() {
      logsCurrentPage++;
      applyLogsFilter();
    });

    async function applyLogsFilter() {
      try {
        const username = document.getElementById('logs-filter-username').value.trim();
        const eventType = document.getElementById('logs-filter-type').value;
        const period = document.getElementById('logs-filter-period').value;
        const limit = parseInt(document.getElementById('logs-limit').value);
        const offset = logsCurrentPage * limit;

        // Build query params
        const params = new URLSearchParams();
        if (username) params.append('username', username);
        if (eventType) params.append('event_type', eventType);
        if (period) {
          const now = Date.now();
          let startTime;
          if (period === '1h') startTime = now - (60 * 60 * 1000);
          else if (period === '24h') startTime = now - (24 * 60 * 60 * 1000);
          else if (period === '7d') startTime = now - (7 * 24 * 60 * 60 * 1000);
          else if (period === '30d') startTime = now - (30 * 24 * 60 * 60 * 1000);
          if (startTime) params.append('start_time', startTime);
        }
        params.append('limit', limit);
        params.append('offset', offset);

        logsCurrentFilters = { username, eventType, period, limit };

        const response = await fetch(`/api/viewer-xp/logs?${params}`);
        const data = await response.json();
        
        if (!data.success) {
          throw new Error(data.error || 'Failed to load logs');
        }

        const events = data.events || [];
        const total = data.pagination?.total || 0;
        
        // Update total count
        document.getElementById('logs-total-count').textContent = `${total} events`;
        
        // Update table
        const tbody = document.getElementById('logs-table-body');
        if (events.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">No events found</td></tr>';
        } else {
          tbody.innerHTML = events.map(event => `
            <tr>
              <td>${formatTimestamp(event.created_at)}</td>
              <td><strong>${escapeHtml(event.username)}</strong></td>
              <td><span class="badge badge-primary">${escapeHtml(event.event_type)}</span></td>
              <td>${event.amount}</td>
              <td><span class="badge badge-success">+${event.xp_awarded} XP</span></td>
              <td><small>${event.meta ? JSON.stringify(event.meta).substring(0, 50) + '...' : '-'}</small></td>
            </tr>
          `).join('');
        }
        
        // Update pagination
        const hasMore = data.pagination?.has_more || false;
        document.getElementById('logs-prev-btn').disabled = logsCurrentPage === 0;
        document.getElementById('logs-next-btn').disabled = !hasMore;
        document.getElementById('logs-page-info').textContent = `Page ${logsCurrentPage + 1} (showing ${offset + 1}-${offset + events.length} of ${total})`;
      } catch (error) {
        console.error('Error loading logs:', error);
        alert('Error loading event logs');
      }
    }

    document.getElementById('logs-export-btn')?.addEventListener('click', async function() {
      try {
        const username = document.getElementById('logs-filter-username').value.trim();
        const eventType = document.getElementById('logs-filter-type').value;
        const period = document.getElementById('logs-filter-period').value;

        // Build request body
        const body = {};
        if (username) body.username = username;
        if (eventType) body.event_type = eventType;
        if (period) {
          const now = Date.now();
          let startTime;
          if (period === '1h') startTime = now - (60 * 60 * 1000);
          else if (period === '24h') startTime = now - (24 * 60 * 60 * 1000);
          else if (period === '7d') startTime = now - (7 * 24 * 60 * 60 * 1000);
          else if (period === '30d') startTime = now - (30 * 24 * 60 * 60 * 1000);
          if (startTime) body.start_time = startTime;
        }

        const response = await fetch('/api/viewer-xp/logs/export', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        const data = await response.json();
        
        // Download as file
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `xp-events-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        alert('Export downloaded successfully!');
      } catch (error) {
        console.error('Error exporting logs:', error);
        alert('Error exporting logs');
      }
    });

    // Helper function to format timestamps
    function formatTimestamp(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
      if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
      
      return date.toLocaleString();
    }
  </script>
</body>
</html>
