<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Unified Game Engine Overlay - LTTH</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: transparent;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
    }

    #unified-container {
      width: 100%;
      height: 100%;
      position: relative;
    }

    .game-frame {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
      opacity: 0;
      pointer-events: none;
      transition: opacity 300ms ease-in-out;
    }

    .game-frame.active {
      opacity: 1;
      pointer-events: auto;
    }

    /* Idle state */
    #idle-state {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      opacity: 0;
      transition: opacity 300ms ease-in-out;
    }

    #idle-state.visible {
      opacity: 1;
    }

    .idle-message {
      text-align: center;
      color: rgba(255, 255, 255, 0.3);
      font-family: 'Arial', sans-serif;
      font-size: 24px;
      text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    }

    /* Queue indicator */
    #queue-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(0, 0, 0, 0.85);
      padding: 15px 20px;
      border-radius: 12px;
      color: white;
      font-family: 'Arial', sans-serif;
      font-size: 14px;
      backdrop-filter: blur(10px);
      border: 2px solid rgba(76, 175, 80, 0.3);
      display: none;
      z-index: 1000;
    }

    #queue-indicator.visible {
      display: block;
      animation: slideInRight 0.4s ease-out;
    }

    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(50px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .queue-title {
      font-weight: 600;
      color: #4CAF50;
      margin-bottom: 5px;
    }

    .queue-item {
      font-size: 12px;
      color: #aaa;
      margin-top: 3px;
    }
  </style>
</head>
<body>
  <div id="unified-container">
    <!-- Game iframes -->
    <iframe id="frame-connect4" class="game-frame" src="/overlay/game-engine/connect4"></iframe>
    <iframe id="frame-chess" class="game-frame" src="/overlay/game-engine/chess"></iframe>
    <iframe id="frame-plinko" class="game-frame" src="/overlay/game-engine/plinko"></iframe>
    <iframe id="frame-wheel" class="game-frame" src="/overlay/game-engine/wheel"></iframe>
    
    <!-- Idle state -->
    <div id="idle-state" class="visible">
      <div class="idle-message">
        ðŸŽ® Waiting for game...
      </div>
    </div>
    
    <!-- Queue indicator -->
    <div id="queue-indicator">
      <div class="queue-title">ðŸ“‹ Queue</div>
      <div id="queue-list"></div>
    </div>
  </div>

  <script>
    const socket = io();
    let currentGame = null;

    // Game switched event
    socket.on('game-engine:game-switched', (data) => {
      console.log('Game switched:', data);
      switchToGame(data.gameType);
    });

    // Game started event (backwards compatibility)
    socket.on('game-engine:game-started', (data) => {
      if (data.useUnified) {
        console.log('Game started (unified):', data);
        switchToGame(data.gameType);
      }
    });

    // Game ended event
    socket.on('game-engine:game-ended', (data) => {
      console.log('Game ended:', data);
      // Wait for next game or go idle
      setTimeout(() => {
        if (!currentGame) {
          showIdleState();
        }
      }, 2000);
    });

    // Queue update events
    socket.on('unified-queue:connect4-queued', (data) => {
      console.log('Connect4 queued:', data);
      updateQueueFromEvent(data);
    });

    socket.on('unified-queue:chess-queued', (data) => {
      console.log('Chess queued:', data);
      updateQueueFromEvent(data);
    });

    socket.on('unified-queue:plinko-queued', (data) => {
      console.log('Plinko queued:', data);
      updateQueueFromEvent(data);
    });

    socket.on('unified-queue:wheel-queued', (data) => {
      console.log('Wheel queued:', data);
      updateQueueFromEvent(data);
    });

    // Idle event
    socket.on('game-engine:idle', () => {
      showIdleState();
    });

    function switchToGame(gameType) {
      // Hide all frames
      document.querySelectorAll('.game-frame').forEach(frame => {
        frame.classList.remove('active');
      });

      // Hide idle state
      document.getElementById('idle-state').classList.remove('visible');

      // Show active game frame
      const frame = document.getElementById(`frame-${gameType}`);
      if (frame) {
        frame.classList.add('active');
        currentGame = gameType;
      } else {
        console.error('Unknown game type:', gameType);
        showIdleState();
      }
    }

    function showIdleState() {
      // Hide all frames
      document.querySelectorAll('.game-frame').forEach(frame => {
        frame.classList.remove('active');
      });

      // Show idle state
      document.getElementById('idle-state').classList.add('visible');
      currentGame = null;
    }

    function updateQueueFromEvent(data) {
      // Simple queue display from individual events
      // Note: This is a simplified version - a full implementation would track the entire queue
      if (data.queueLength > 0) {
        const indicator = document.getElementById('queue-indicator');
        const list = document.getElementById('queue-list');
        
        indicator.classList.add('visible');
        list.innerHTML = `<div class="queue-item">${data.queueLength} game(s) in queue</div>`;
        
        // Hide after 5 seconds if queue becomes empty
        setTimeout(() => {
          // Note: We hide after timeout regardless - in production, listen to queue-cleared events
          indicator.classList.remove('visible');
        }, 5000);
      }
    }

    // Request initial state
    socket.emit('game-engine:request-state');
    
    console.log('Unified Game Engine Overlay loaded');
  </script>
</body>
</html>
